'use strict';window.DOMHandler=class{constructor(p,q){this._iRuntime=p;this._componentId=q;this._hasTickCallback=!1;this._tickCallback=()=>this.Tick()}Attach(){}PostToRuntime(p,q,n,u){this._iRuntime.PostToRuntimeComponent(this._componentId,p,q,n,u)}PostToRuntimeAsync(p,q,n,u){return this._iRuntime.PostToRuntimeComponentAsync(this._componentId,p,q,n,u)}_PostToRuntimeMaybeSync(p,q,n){this._iRuntime.UsesWorker()?this.PostToRuntime(p,q,n):this._iRuntime._GetLocalRuntime()._OnMessageFromDOM({type:"event",
component:this._componentId,handler:p,dispatchOpts:n||null,data:q,responseId:null})}AddRuntimeMessageHandler(p,q){this._iRuntime.AddRuntimeComponentMessageHandler(this._componentId,p,q)}AddRuntimeMessageHandlers(p){for(const [q,n]of p)this.AddRuntimeMessageHandler(q,n)}GetRuntimeInterface(){return this._iRuntime}GetComponentID(){return this._componentId}_StartTicking(){this._hasTickCallback||(this._iRuntime._AddRAFCallback(this._tickCallback),this._hasTickCallback=!0)}_StopTicking(){this._hasTickCallback&&
(this._iRuntime._RemoveRAFCallback(this._tickCallback),this._hasTickCallback=!1)}Tick(){}};
window.RateLimiter=class{constructor(p,q){this._callback=p;this._interval=q;this._timerId=-1;this._lastCallTime=-Infinity;this._timerCallFunc=()=>this._OnTimer();this._canRunImmediate=this._ignoreReset=!1}SetCanRunImmediate(p){this._canRunImmediate=!!p}Call(){if(-1===this._timerId){var p=Date.now(),q=p-this._lastCallTime,n=this._interval;q>=n&&this._canRunImmediate?(this._lastCallTime=p,this._RunCallback()):this._timerId=self.setTimeout(this._timerCallFunc,Math.max(n-q,4))}}_RunCallback(){this._ignoreReset=
!0;this._callback();this._ignoreReset=!1}Reset(){this._ignoreReset||(this._CancelTimer(),this._lastCallTime=Date.now())}_OnTimer(){this._timerId=-1;this._lastCallTime=Date.now();this._RunCallback()}_CancelTimer(){-1!==this._timerId&&(self.clearTimeout(this._timerId),this._timerId=-1)}Release(){this._CancelTimer();this._timerCallFunc=this._callback=null}};"use strict";
window.DOMElementHandler=class extends self.DOMHandler{constructor(p,q){super(p,q);this._elementMap=new Map;this._autoAttach=!0;this.AddRuntimeMessageHandlers([["create",n=>this._OnCreate(n)],["destroy",n=>this._OnDestroy(n)],["set-visible",n=>this._OnSetVisible(n)],["update-position",n=>this._OnUpdatePosition(n)],["update-state",n=>this._OnUpdateState(n)],["focus",n=>this._OnSetFocus(n)],["set-css-style",n=>this._OnSetCssStyle(n)],["set-attribute",n=>this._OnSetAttribute(n)],["remove-attribute",
n=>this._OnRemoveAttribute(n)]]);this.AddDOMElementMessageHandler("get-element",n=>n)}SetAutoAttach(p){this._autoAttach=!!p}AddDOMElementMessageHandler(p,q){this.AddRuntimeMessageHandler(p,n=>{const u=this._elementMap.get(n.elementId);return q(u,n)})}_OnCreate(p){const q=p.elementId,n=this.CreateElement(q,p);this._elementMap.set(q,n);p.isVisible||(n.style.display="none");p=this._GetFocusElement(n);p.addEventListener("focus",u=>this._OnFocus(q));p.addEventListener("blur",u=>this._OnBlur(q));this._autoAttach&&
document.body.appendChild(n)}CreateElement(p,q){throw Error("required override");}DestroyElement(p){}_OnDestroy(p){p=p.elementId;const q=this._elementMap.get(p);this.DestroyElement(q);this._autoAttach&&q.parentElement.removeChild(q);this._elementMap.delete(p)}PostToRuntimeElement(p,q,n){n||(n={});n.elementId=q;this.PostToRuntime(p,n)}_PostToRuntimeElementMaybeSync(p,q,n){n||(n={});n.elementId=q;this._PostToRuntimeMaybeSync(p,n)}_OnSetVisible(p){this._autoAttach&&(this._elementMap.get(p.elementId).style.display=
p.isVisible?"":"none")}_OnUpdatePosition(p){if(this._autoAttach){var q=this._elementMap.get(p.elementId);q.style.left=p.left+"px";q.style.top=p.top+"px";q.style.width=p.width+"px";q.style.height=p.height+"px";p=p.fontSize;null!==p&&(q.style.fontSize=p+"em")}}_OnUpdateState(p){const q=this._elementMap.get(p.elementId);this.UpdateState(q,p)}UpdateState(p,q){throw Error("required override");}_GetFocusElement(p){return p}_OnFocus(p){this.PostToRuntimeElement("elem-focused",p)}_OnBlur(p){this.PostToRuntimeElement("elem-blurred",
p)}_OnSetFocus(p){const q=this._GetFocusElement(this._elementMap.get(p.elementId));p.focus?q.focus():q.blur()}_OnSetCssStyle(p){this._elementMap.get(p.elementId).style[p.prop]=p.val}_OnSetAttribute(p){this._elementMap.get(p.elementId).setAttribute(p.name,p.val)}_OnRemoveAttribute(p){this._elementMap.get(p.elementId).removeAttribute(p.name)}GetElementById(p){return this._elementMap.get(p)}};"use strict";
{const p=/(iphone|ipod|ipad|macos|macintosh|mac os x)/i.test(navigator.userAgent);let q=0;function n(d){const a=document.createElement("script");a.async=!1;a.type="module";return d.isStringSrc?new Promise(l=>{const m="c3_resolve_"+q;++q;self[m]=l;a.textContent=d.str+`\n\nself["${m}"]();`;document.head.appendChild(a)}):new Promise((l,m)=>{a.onload=l;a.onerror=m;a.src=d;document.head.appendChild(a)})}let u=!1,w=!1;function E(){if(!u){try{new Worker("blob://",{get type(){w=!0}})}catch(d){}u=!0}return w}
let z=new Audio;const f={"audio/webm; codecs=opus":!!z.canPlayType("audio/webm; codecs=opus"),"audio/ogg; codecs=opus":!!z.canPlayType("audio/ogg; codecs=opus"),"audio/webm; codecs=vorbis":!!z.canPlayType("audio/webm; codecs=vorbis"),"audio/ogg; codecs=vorbis":!!z.canPlayType("audio/ogg; codecs=vorbis"),"audio/mp4":!!z.canPlayType("audio/mp4"),"audio/mpeg":!!z.canPlayType("audio/mpeg")};z=null;async function h(d){d=await b(d);return(new TextDecoder("utf-8")).decode(d)}function b(d){return new Promise((a,
l)=>{const m=new FileReader;m.onload=t=>a(t.target.result);m.onerror=t=>l(t);m.readAsArrayBuffer(d)})}const c=[];let g=0;window.RealFile=window.File;const v=[],e=new Map,k=new Map;let r=0;const x=[];self.runOnStartup=function(d){if("function"!==typeof d)throw Error("runOnStartup called without a function");x.push(d)};const y=new Set(["cordova","playable-ad","instant-games"]);function D(d){return y.has(d)}let G=!1;window.RuntimeInterface=class d{constructor(a){this._useWorker=a.useWorker;this._messageChannelPort=
null;this._baseUrl="";this._scriptFolder=a.scriptFolder;this._workerScriptURLs={};this._localRuntime=this._worker=null;this._domHandlers=[];this._jobScheduler=this._canvas=this._runtimeDomHandler=null;this._rafId=-1;this._rafFunc=()=>this._OnRAFCallback();this._rafCallbacks=[];this._exportType=a.exportType;!this._useWorker||"undefined"!==typeof OffscreenCanvas&&navigator.userActivation&&E()||(this._useWorker=!1);D(this._exportType)&&this._useWorker&&(console.warn("[C3 runtime] Worker mode is enabled and supported, but is currently disabled in WebViews. Reverting to DOM mode."),
this._useWorker=!1);this._localFileStrings=this._localFileBlobs=null;"html5"!==this._exportType&&"playable-ad"!==this._exportType||"file"!==location.protocol.substr(0,4)||alert("Exported games won't work until you upload them. (When running on the file: protocol, browsers block many features from working for security reasons.)");this.AddRuntimeComponentMessageHandler("runtime","cordova-fetch-local-file",l=>this._OnCordovaFetchLocalFile(l));this.AddRuntimeComponentMessageHandler("runtime","create-job-worker",
l=>this._OnCreateJobWorker(l));"cordova"===this._exportType?document.addEventListener("deviceready",()=>this._Init(a)):this._Init(a)}Release(){this._CancelAnimationFrame();this._messageChannelPort&&(this._messageChannelPort=this._messageChannelPort.onmessage=null);this._worker&&(this._worker.terminate(),this._worker=null);this._localRuntime&&(this._localRuntime.Release(),this._localRuntime=null);this._canvas&&(this._canvas.parentElement.removeChild(this._canvas),this._canvas=null)}GetCanvas(){return this._canvas}GetBaseURL(){return this._baseUrl}UsesWorker(){return this._useWorker}GetExportType(){return this._exportType}GetScriptFolder(){return this._scriptFolder}IsiOSCordova(){return p&&
"cordova"===this._exportType}IsiOSWebView(){return p&&D(this._exportType)||navigator.standalone}async _Init(a){"macos-wkwebview"===this._exportType&&this._SendWrapperMessage({type:"ready"});if("playable-ad"===this._exportType){this._localFileBlobs=self.c3_base64files;this._localFileStrings={};await this._ConvertDataUrisToBlobs();for(let m=0,t=a.engineScripts.length;m<t;++m){var l=a.engineScripts[m].toLowerCase();this._localFileStrings.hasOwnProperty(l)?a.engineScripts[m]={isStringSrc:!0,str:this._localFileStrings[l]}:
this._localFileBlobs.hasOwnProperty(l)&&(a.engineScripts[m]=URL.createObjectURL(this._localFileBlobs[l]))}}a.baseUrl?this._baseUrl=a.baseUrl:(l=location.origin,this._baseUrl=("null"===l?"file:///":l)+location.pathname,l=this._baseUrl.lastIndexOf("/"),-1!==l&&(this._baseUrl=this._baseUrl.substr(0,l+1)));a.workerScripts&&(this._workerScriptURLs=a.workerScripts);l=new MessageChannel;this._messageChannelPort=l.port1;this._messageChannelPort.onmessage=m=>this._OnMessageFromRuntime(m.data);window.c3_addPortMessageHandler&&
window.c3_addPortMessageHandler(m=>this._OnMessageFromDebugger(m));this._jobScheduler=new self.JobSchedulerDOM(this);await this._jobScheduler.Init();"object"===typeof window.StatusBar&&window.StatusBar.hide();"object"===typeof window.AndroidFullScreen&&window.AndroidFullScreen.immersiveMode();this._useWorker?await this._InitWorker(a,l.port2):await this._InitDOM(a,l.port2)}_GetWorkerURL(a){a=this._workerScriptURLs.hasOwnProperty(a)?this._workerScriptURLs[a]:a.endsWith("/workermain.js")&&this._workerScriptURLs.hasOwnProperty("workermain.js")?
this._workerScriptURLs["workermain.js"]:"playable-ad"===this._exportType&&this._localFileBlobs.hasOwnProperty(a.toLowerCase())?this._localFileBlobs[a.toLowerCase()]:a;a instanceof Blob&&(a=URL.createObjectURL(a));return a}async CreateWorker(a,l,m){if(a.startsWith("blob:"))return new Worker(a,m);if(this.IsiOSCordova()&&"file:"===location.protocol)return a=await this.CordovaFetchLocalFileAsArrayBuffer(this._scriptFolder+a),a=new Blob([a],{type:"application/javascript"}),new Worker(URL.createObjectURL(a),
m);a=new URL(a,l);if(location.origin!==a.origin){a=await fetch(a);if(!a.ok)throw Error("failed to fetch worker script");a=await a.blob();return new Worker(URL.createObjectURL(a),m)}return new Worker(a,m)}_GetWindowInnerWidth(){return Math.max(window.innerWidth,1)}_GetWindowInnerHeight(){return Math.max(window.innerHeight,1)}_GetCommonRuntimeOptions(a){return{baseUrl:this._baseUrl,windowInnerWidth:this._GetWindowInnerWidth(),windowInnerHeight:this._GetWindowInnerHeight(),devicePixelRatio:window.devicePixelRatio,
isFullscreen:d.IsDocumentFullscreen(),projectData:a.projectData,previewImageBlobs:window.cr_previewImageBlobs||this._localFileBlobs,previewProjectFileBlobs:window.cr_previewProjectFileBlobs,previewProjectFileSWUrls:window.cr_previewProjectFiles,swClientId:window.cr_swClientId||"",exportType:a.exportType,isDebug:-1<self.location.search.indexOf("debug"),ife:!!self.ife,jobScheduler:this._jobScheduler.GetPortData(),supportedAudioFormats:f,opusWasmScriptUrl:window.cr_opusWasmScriptUrl||this._scriptFolder+
"opus.wasm.js",opusWasmBinaryUrl:window.cr_opusWasmBinaryUrl||this._scriptFolder+"opus.wasm.wasm",isiOSCordova:this.IsiOSCordova(),isiOSWebView:this.IsiOSWebView(),isFBInstantAvailable:"undefined"!==typeof self.FBInstant}}async _InitWorker(a,l){var m=this._GetWorkerURL(a.workerMainUrl);this._worker=await this.CreateWorker(m,this._baseUrl,{type:"module",name:"Runtime"});this._canvas=document.createElement("canvas");this._canvas.style.display="none";m=this._canvas.transferControlToOffscreen();document.body.appendChild(this._canvas);
window.c3canvas=this._canvas;this._worker.postMessage(Object.assign(this._GetCommonRuntimeOptions(a),{type:"init-runtime",isInWorker:!0,messagePort:l,canvas:m,workerDependencyScripts:a.workerDependencyScripts||[],engineScripts:a.engineScripts,projectScripts:a.projectScripts,mainProjectScript:a.mainProjectScript,projectScriptsStatus:self.C3_ProjectScriptsStatus}),[l,m,...this._jobScheduler.GetPortTransferables()]);this._domHandlers=v.map(t=>new t(this));this._FindRuntimeDOMHandler();self.c3_callFunction=
(t,A)=>this._runtimeDomHandler._InvokeFunctionFromJS(t,A);"preview"===this._exportType&&(self.goToLastErrorScript=()=>this.PostToRuntimeComponent("runtime","go-to-last-error-script"))}async _InitDOM(a,l){this._canvas=document.createElement("canvas");this._canvas.style.display="none";document.body.appendChild(this._canvas);window.c3canvas=this._canvas;this._domHandlers=v.map(B=>new B(this));this._FindRuntimeDOMHandler();var m=a.engineScripts.map(B=>"string"===typeof B?(new URL(B,this._baseUrl)).toString():
B);Array.isArray(a.workerDependencyScripts)&&m.unshift(...a.workerDependencyScripts);m=await Promise.all(m.map(B=>this._MaybeGetCordovaScriptURL(B)));await Promise.all(m.map(B=>n(B)));m=self.C3_ProjectScriptsStatus;const t=a.mainProjectScript,A=a.projectScripts;for(let [B,C]of A)if(C||(C=B),B===t)try{C=await this._MaybeGetCordovaScriptURL(C),await n(C),"preview"!==this._exportType||m[B]||this._ReportProjectMainScriptError(B,"main script did not run to completion")}catch(F){this._ReportProjectMainScriptError(B,
F)}else if("scriptsInEvents.js"===B||B.endsWith("/scriptsInEvents.js"))C=await this._MaybeGetCordovaScriptURL(C),await n(C);"preview"===this._exportType&&"object"!==typeof self.C3.ScriptsInEvents?(this._RemoveLoadingMessage(),console.error("[C3 runtime] Failed to load JavaScript code used in events. Check all your JavaScript code has valid syntax."),alert("Failed to load JavaScript code used in events. Check all your JavaScript code has valid syntax.")):(a=Object.assign(this._GetCommonRuntimeOptions(a),
{isInWorker:!1,messagePort:l,canvas:this._canvas,runOnStartupFunctions:x}),this._OnBeforeCreateRuntime(),this._localRuntime=self.C3_CreateRuntime(a),await self.C3_InitRuntime(this._localRuntime,a))}_ReportProjectMainScriptError(a,l){this._RemoveLoadingMessage();console.error(`[Preview] Failed to load project main script (${a}): `,l);alert(`Failed to load project main script (${a}). Check all your JavaScript code has valid syntax. Press F12 and check the console for error details.`)}_OnBeforeCreateRuntime(){this._RemoveLoadingMessage()}_RemoveLoadingMessage(){const a=
window.cr_previewLoadingElem;a&&(a.parentElement.removeChild(a),window.cr_previewLoadingElem=null)}async _OnCreateJobWorker(a){a=await this._jobScheduler._CreateJobWorker();return{outputPort:a,transferables:[a]}}_GetLocalRuntime(){if(this._useWorker)throw Error("not available in worker mode");return this._localRuntime}PostToRuntimeComponent(a,l,m,t,A){this._messageChannelPort.postMessage({type:"event",component:a,handler:l,dispatchOpts:t||null,data:m,responseId:null},A)}PostToRuntimeComponentAsync(a,
l,m,t,A){const B=r++,C=new Promise((F,H)=>{k.set(B,{resolve:F,reject:H})});this._messageChannelPort.postMessage({type:"event",component:a,handler:l,dispatchOpts:t||null,data:m,responseId:B},A);return C}["_OnMessageFromRuntime"](a){const l=a.type;if("event"===l)return this._OnEventFromRuntime(a);if("result"===l)this._OnResultFromRuntime(a);else if("runtime-ready"===l)this._OnRuntimeReady();else if("alert-error"===l)this._RemoveLoadingMessage(),alert(a.message);else if("creating-runtime"===l)this._OnBeforeCreateRuntime();
else throw Error(`unknown message '${l}'`);}_OnEventFromRuntime(a){const l=a.component,m=a.handler,t=a.data,A=a.responseId;if(a=e.get(l))if(a=a.get(m)){var B=null;try{B=a(t)}catch(C){console.error(`Exception in '${l}' handler '${m}':`,C);null!==A&&this._PostResultToRuntime(A,!1,""+C);return}if(null===A)return B;B&&B.then?B.then(C=>this._PostResultToRuntime(A,!0,C)).catch(C=>{console.error(`Rejection from '${l}' handler '${m}':`,C);this._PostResultToRuntime(A,!1,""+C)}):this._PostResultToRuntime(A,
!0,B)}else console.warn(`[DOM] No handler '${m}' for component '${l}'`);else console.warn(`[DOM] No event handlers for component '${l}'`)}_PostResultToRuntime(a,l,m){let t;m&&m.transferables&&(t=m.transferables);this._messageChannelPort.postMessage({type:"result",responseId:a,isOk:l,result:m},t)}_OnResultFromRuntime(a){const l=a.responseId,m=a.isOk;a=a.result;const t=k.get(l);m?t.resolve(a):t.reject(a);k.delete(l)}AddRuntimeComponentMessageHandler(a,l,m){let t=e.get(a);t||(t=new Map,e.set(a,t));if(t.has(l))throw Error(`[DOM] Component '${a}' already has handler '${l}'`);
t.set(l,m)}static AddDOMHandlerClass(a){if(v.includes(a))throw Error("DOM handler already added");v.push(a)}_FindRuntimeDOMHandler(){for(const a of this._domHandlers)if("runtime"===a.GetComponentID()){this._runtimeDomHandler=a;return}throw Error("cannot find runtime DOM handler");}_OnMessageFromDebugger(a){this.PostToRuntimeComponent("debugger","message",a)}_OnRuntimeReady(){for(const a of this._domHandlers)a.Attach()}static IsDocumentFullscreen(){return!!(document.fullscreenElement||document.webkitFullscreenElement||
document.mozFullScreenElement||G)}static _SetWrapperIsFullscreenFlag(a){G=!!a}async GetRemotePreviewStatusInfo(){return await this.PostToRuntimeComponentAsync("runtime","get-remote-preview-status-info")}_AddRAFCallback(a){this._rafCallbacks.push(a);this._RequestAnimationFrame()}_RemoveRAFCallback(a){a=this._rafCallbacks.indexOf(a);if(-1===a)throw Error("invalid callback");this._rafCallbacks.splice(a,1);this._rafCallbacks.length||this._CancelAnimationFrame()}_RequestAnimationFrame(){-1===this._rafId&&
this._rafCallbacks.length&&(this._rafId=requestAnimationFrame(this._rafFunc))}_CancelAnimationFrame(){-1!==this._rafId&&(cancelAnimationFrame(this._rafId),this._rafId=-1)}_OnRAFCallback(){this._rafId=-1;for(const a of this._rafCallbacks)a();this._RequestAnimationFrame()}TryPlayMedia(a){this._runtimeDomHandler.TryPlayMedia(a)}RemovePendingPlay(a){this._runtimeDomHandler.RemovePendingPlay(a)}_PlayPendingMedia(){this._runtimeDomHandler._PlayPendingMedia()}SetSilent(a){this._runtimeDomHandler.SetSilent(a)}IsAudioFormatSupported(a){return!!f[a]}async _WasmDecodeWebMOpus(a){a=
await this.PostToRuntimeComponentAsync("runtime","opus-decode",{arrayBuffer:a},null,[a]);return new Float32Array(a)}IsAbsoluteURL(a){return/^(?:[a-z\-]+:)?\/\//.test(a)||"data:"===a.substr(0,5)||"blob:"===a.substr(0,5)}IsRelativeURL(a){return!this.IsAbsoluteURL(a)}async _MaybeGetCordovaScriptURL(a){return"cordova"===this._exportType&&(a.startsWith("file:")||"file:"===location.protocol&&this.IsRelativeURL(a))?(a.startsWith(this._baseUrl)&&(a=a.substr(this._baseUrl.length)),a=await this.CordovaFetchLocalFileAsArrayBuffer(a),
a=new Blob([a],{type:"application/javascript"}),URL.createObjectURL(a)):a}async _OnCordovaFetchLocalFile(a){const l=a.filename;switch(a.as){case "text":return await this.CordovaFetchLocalFileAsText(l);case "buffer":return await this.CordovaFetchLocalFileAsArrayBuffer(l);default:throw Error("unsupported type");}}_GetPermissionAPI(){const a=window.cordova&&window.cordova.plugins&&window.cordova.plugins.permissions;if("object"!==typeof a)throw Error("Permission API is not loaded");return a}_MapPermissionID(a,
l){a=a[l];if("string"!==typeof a)throw Error("Invalid permission name");return a}_HasPermission(a){const l=this._GetPermissionAPI();return new Promise((m,t)=>l.checkPermission(this._MapPermissionID(l,a),A=>m(!!A.hasPermission),t))}_RequestPermission(a){const l=this._GetPermissionAPI();return new Promise((m,t)=>l.requestPermission(this._MapPermissionID(l,a),A=>m(!!A.hasPermission),t))}async RequestPermissions(a){if("cordova"!==this.GetExportType()||this.IsiOSCordova())return!0;for(const l of a)if(!await this._HasPermission(l)&&
!1===await this._RequestPermission(l))return!1;return!0}async RequirePermissions(...a){if(!1===await this.RequestPermissions(a))throw Error("Permission not granted");}CordovaFetchLocalFile(a){const l=window.cordova.file.applicationDirectory+"www/"+a.toLowerCase();return new Promise((m,t)=>{window.resolveLocalFileSystemURL(l,A=>{A.file(m,t)},t)})}async CordovaFetchLocalFileAsText(a){a=await this.CordovaFetchLocalFile(a);return await h(a)}_CordovaMaybeStartNextArrayBufferRead(){if(c.length&&!(8<=g)){g++;
var a=c.shift();this._CordovaDoFetchLocalFileAsAsArrayBuffer(a.filename,a.successCallback,a.errorCallback)}}CordovaFetchLocalFileAsArrayBuffer(a){return new Promise((l,m)=>{c.push({filename:a,successCallback:t=>{g--;this._CordovaMaybeStartNextArrayBufferRead();l(t)},errorCallback:t=>{g--;this._CordovaMaybeStartNextArrayBufferRead();m(t)}});this._CordovaMaybeStartNextArrayBufferRead()})}async _CordovaDoFetchLocalFileAsAsArrayBuffer(a,l,m){try{const t=await this.CordovaFetchLocalFile(a),A=await b(t);
l(A)}catch(t){m(t)}}_SendWrapperMessage(a){if("windows-webview2"===this._exportType)window.chrome.webview.postMessage(JSON.stringify(a));else if("macos-wkwebview"===this._exportType)window.webkit.messageHandlers.C3Wrapper.postMessage(JSON.stringify(a));else throw Error("cannot send wrapper message");}async _ConvertDataUrisToBlobs(){const a=[];for(const [l,m]of Object.entries(this._localFileBlobs))a.push(this._ConvertDataUriToBlobs(l,m));await Promise.all(a)}async _ConvertDataUriToBlobs(a,l){if("object"===
typeof l)this._localFileBlobs[a]=new Blob([l.str],{type:l.type}),this._localFileStrings[a]=l.str;else{let m=await this._FetchDataUri(l);m||(m=this._DataURIToBinaryBlobSync(l));this._localFileBlobs[a]=m}}async _FetchDataUri(a){try{return await (await fetch(a)).blob()}catch(l){return console.warn("Failed to fetch a data: URI. Falling back to a slower workaround. This is probably because the Content Security Policy unnecessarily blocked it. Allow data: URIs in your CSP to avoid this.",l),null}}_DataURIToBinaryBlobSync(a){a=
this._ParseDataURI(a);return this._BinaryStringToBlob(a.data,a.mime_type)}_ParseDataURI(a){var l=a.indexOf(",");if(0>l)throw new URIError("expected comma in data: uri");var m=a.substring(5,l);a=a.substring(l+1);l=m.split(";");m=l[0]||"";const t=l[2];a="base64"===l[1]||"base64"===t?atob(a):decodeURIComponent(a);return{mime_type:m,data:a}}_BinaryStringToBlob(a,l){var m=a.length;let t=m>>2,A=new Uint8Array(m),B=new Uint32Array(A.buffer,0,t),C,F;for(F=C=0;C<t;++C)B[C]=a.charCodeAt(F++)|a.charCodeAt(F++)<<
8|a.charCodeAt(F++)<<16|a.charCodeAt(F++)<<24;for(m&=3;m--;)A[F]=a.charCodeAt(F),++F;return new Blob([A],{type:l})}}}"use strict";
{const p=self.RuntimeInterface;function q(d){return d.sourceCapabilities&&d.sourceCapabilities.firesTouchEvents||d.originalEvent&&d.originalEvent.sourceCapabilities&&d.originalEvent.sourceCapabilities.firesTouchEvents}const n=new Map([["OSLeft","MetaLeft"],["OSRight","MetaRight"]]),u={dispatchRuntimeEvent:!0,dispatchUserScriptEvent:!0},w={dispatchUserScriptEvent:!0},E={dispatchRuntimeEvent:!0};function z(d){return new Promise((a,l)=>{const m=document.createElement("link");m.onload=()=>a(m);m.onerror=
t=>l(t);m.rel="stylesheet";m.href=d;document.head.appendChild(m)})}function f(d){return new Promise((a,l)=>{const m=new Image;m.onload=()=>a(m);m.onerror=t=>l(t);m.src=d})}async function h(d){d=URL.createObjectURL(d);try{return await f(d)}finally{URL.revokeObjectURL(d)}}function b(d){return new Promise((a,l)=>{let m=new FileReader;m.onload=t=>a(t.target.result);m.onerror=t=>l(t);m.readAsText(d)})}async function c(d,a,l){if(!/firefox/i.test(navigator.userAgent))return await h(d);var m=await b(d);m=
(new DOMParser).parseFromString(m,"image/svg+xml");const t=m.documentElement;if(t.hasAttribute("width")&&t.hasAttribute("height")){const A=t.getAttribute("width"),B=t.getAttribute("height");if(!A.includes("%")&&!B.includes("%"))return await h(d)}t.setAttribute("width",a+"px");t.setAttribute("height",l+"px");m=(new XMLSerializer).serializeToString(m);d=new Blob([m],{type:"image/svg+xml"});return await h(d)}function g(d){do{if(d.parentNode&&d.hasAttribute("contenteditable"))return!0;d=d.parentNode}while(d);
return!1}const v=new Set(["input","textarea","datalist","select"]);function e(d){return v.has(d.tagName.toLowerCase())||g(d)}const k=new Set(["canvas","body","html"]);function r(d){const a=d.target.tagName.toLowerCase();k.has(a)&&d.preventDefault()}function x(d){(d.metaKey||d.ctrlKey)&&d.preventDefault()}self.C3_GetSvgImageSize=async function(d){d=await h(d);if(0<d.width&&0<d.height)return[d.width,d.height];{d.style.position="absolute";d.style.left="0px";d.style.top="0px";d.style.visibility="hidden";
document.body.appendChild(d);const a=d.getBoundingClientRect();document.body.removeChild(d);return[a.width,a.height]}};self.C3_RasterSvgImageBlob=async function(d,a,l,m,t){d=await c(d,a,l);const A=document.createElement("canvas");A.width=m;A.height=t;A.getContext("2d").drawImage(d,0,0,a,l);return A};let y=!1;document.addEventListener("pause",()=>y=!0);document.addEventListener("resume",()=>y=!1);function D(){try{return window.parent&&window.parent.document.hasFocus()}catch(d){return!1}}function G(){const d=
document.activeElement;if(!d)return!1;const a=d.tagName.toLowerCase(),l=new Set("email number password search tel text url".split(" "));return"textarea"===a?!0:"input"===a?l.has(d.type.toLowerCase()||"text"):g(d)}p.AddDOMHandlerClass(class extends self.DOMHandler{constructor(d){super(d,"runtime");this._isFirstSizeUpdate=!0;this._simulatedResizeTimerId=-1;this._targetOrientation="any";this._attachedDeviceMotionEvent=this._attachedDeviceOrientationEvent=!1;this._lastPointerRawUpdateEvent=this._pointerRawUpdateRateLimiter=
this._debugHighlightElem=null;d.AddRuntimeComponentMessageHandler("canvas","update-size",m=>this._OnUpdateCanvasSize(m));d.AddRuntimeComponentMessageHandler("runtime","invoke-download",m=>this._OnInvokeDownload(m));d.AddRuntimeComponentMessageHandler("runtime","raster-svg-image",m=>this._OnRasterSvgImage(m));d.AddRuntimeComponentMessageHandler("runtime","get-svg-image-size",m=>this._OnGetSvgImageSize(m));d.AddRuntimeComponentMessageHandler("runtime","set-target-orientation",m=>this._OnSetTargetOrientation(m));
d.AddRuntimeComponentMessageHandler("runtime","register-sw",()=>this._OnRegisterSW());d.AddRuntimeComponentMessageHandler("runtime","post-to-debugger",m=>this._OnPostToDebugger(m));d.AddRuntimeComponentMessageHandler("runtime","go-to-script",m=>this._OnPostToDebugger(m));d.AddRuntimeComponentMessageHandler("runtime","before-start-ticking",()=>this._OnBeforeStartTicking());d.AddRuntimeComponentMessageHandler("runtime","debug-highlight",m=>this._OnDebugHighlight(m));d.AddRuntimeComponentMessageHandler("runtime",
"enable-device-orientation",()=>this._AttachDeviceOrientationEvent());d.AddRuntimeComponentMessageHandler("runtime","enable-device-motion",()=>this._AttachDeviceMotionEvent());d.AddRuntimeComponentMessageHandler("runtime","add-stylesheet",m=>this._OnAddStylesheet(m));d.AddRuntimeComponentMessageHandler("runtime","alert",m=>this._OnAlert(m));d.AddRuntimeComponentMessageHandler("runtime","hide-cordova-splash",()=>this._OnHideCordovaSplash());const a=new Set(["input","textarea","datalist"]);window.addEventListener("contextmenu",
m=>{const t=m.target,A=t.tagName.toLowerCase();a.has(A)||g(t)||m.preventDefault()});const l=d.GetCanvas();window.addEventListener("selectstart",r);window.addEventListener("gesturehold",r);l.addEventListener("selectstart",r);l.addEventListener("gesturehold",r);window.addEventListener("touchstart",r,{passive:!1});"undefined"!==typeof PointerEvent?(window.addEventListener("pointerdown",r,{passive:!1}),l.addEventListener("pointerdown",r)):l.addEventListener("touchstart",r);this._mousePointerLastButtons=
0;window.addEventListener("mousedown",m=>{1===m.button&&m.preventDefault()});window.addEventListener("mousewheel",x,{passive:!1});window.addEventListener("wheel",x,{passive:!1});window.addEventListener("resize",()=>this._OnWindowResize());window.addEventListener("fullscreenchange",()=>this._OnFullscreenChange());window.addEventListener("webkitfullscreenchange",()=>this._OnFullscreenChange());window.addEventListener("mozfullscreenchange",()=>this._OnFullscreenChange());window.addEventListener("fullscreenerror",
m=>this._OnFullscreenError(m));window.addEventListener("webkitfullscreenerror",m=>this._OnFullscreenError(m));window.addEventListener("mozfullscreenerror",m=>this._OnFullscreenError(m));d.IsiOSWebView()&&window.addEventListener("focusout",()=>{G()||(document.scrollingElement.scrollTop=0)});self.C3WrapperOnMessage=m=>this._OnWrapperMessage(m);this._mediaPendingPlay=new Set;this._mediaRemovedPendingPlay=new WeakSet;this._isSilent=!1}_OnBeforeStartTicking(){"cordova"===this._iRuntime.GetExportType()?
(document.addEventListener("pause",()=>this._OnVisibilityChange(!0)),document.addEventListener("resume",()=>this._OnVisibilityChange(!1))):document.addEventListener("visibilitychange",()=>this._OnVisibilityChange(document.hidden));return{isSuspended:!(!document.hidden&&!y)}}Attach(){window.addEventListener("focus",()=>this._PostRuntimeEvent("window-focus"));window.addEventListener("blur",()=>{this._PostRuntimeEvent("window-blur",{parentHasFocus:D()});this._mousePointerLastButtons=0});window.addEventListener("focusin",
a=>{e(a.target)&&this._PostRuntimeEvent("keyboard-blur")});window.addEventListener("keydown",a=>this._OnKeyEvent("keydown",a));window.addEventListener("keyup",a=>this._OnKeyEvent("keyup",a));window.addEventListener("dblclick",a=>this._OnMouseEvent("dblclick",a,u));window.addEventListener("wheel",a=>this._OnMouseWheelEvent("wheel",a));"undefined"!==typeof PointerEvent?(window.addEventListener("pointerdown",a=>{this._HandlePointerDownFocus(a);this._OnPointerEvent("pointerdown",a)}),this._iRuntime.UsesWorker()&&
"undefined"!==typeof window.onpointerrawupdate&&self===self.top?(this._pointerRawUpdateRateLimiter=new self.RateLimiter(()=>this._DoSendPointerRawUpdate(),5),this._pointerRawUpdateRateLimiter.SetCanRunImmediate(!0),window.addEventListener("pointerrawupdate",a=>this._OnPointerRawUpdate(a))):window.addEventListener("pointermove",a=>this._OnPointerEvent("pointermove",a)),window.addEventListener("pointerup",a=>this._OnPointerEvent("pointerup",a)),window.addEventListener("pointercancel",a=>this._OnPointerEvent("pointercancel",
a))):(window.addEventListener("mousedown",a=>{this._HandlePointerDownFocus(a);this._OnMouseEventAsPointer("pointerdown",a)}),window.addEventListener("mousemove",a=>this._OnMouseEventAsPointer("pointermove",a)),window.addEventListener("mouseup",a=>this._OnMouseEventAsPointer("pointerup",a)),window.addEventListener("touchstart",a=>{this._HandlePointerDownFocus(a);this._OnTouchEvent("pointerdown",a)}),window.addEventListener("touchmove",a=>this._OnTouchEvent("pointermove",a)),window.addEventListener("touchend",
a=>this._OnTouchEvent("pointerup",a)),window.addEventListener("touchcancel",a=>this._OnTouchEvent("pointercancel",a)));const d=()=>this._PlayPendingMedia();window.addEventListener("pointerup",d,!0);window.addEventListener("touchend",d,!0);window.addEventListener("click",d,!0);window.addEventListener("keydown",d,!0);window.addEventListener("gamepadconnected",d,!0)}_PostRuntimeEvent(d,a){this.PostToRuntime(d,a||null,E)}_GetWindowInnerWidth(){return this._iRuntime._GetWindowInnerWidth()}_GetWindowInnerHeight(){return this._iRuntime._GetWindowInnerHeight()}_OnWindowResize(){const d=
this._GetWindowInnerWidth(),a=this._GetWindowInnerHeight();this._PostRuntimeEvent("window-resize",{innerWidth:d,innerHeight:a,devicePixelRatio:window.devicePixelRatio,isFullscreen:p.IsDocumentFullscreen()});this._iRuntime.IsiOSWebView()&&(-1!==this._simulatedResizeTimerId&&clearTimeout(this._simulatedResizeTimerId),this._OnSimulatedResize(d,a,0))}_ScheduleSimulatedResize(d,a,l){-1!==this._simulatedResizeTimerId&&clearTimeout(this._simulatedResizeTimerId);this._simulatedResizeTimerId=setTimeout(()=>
this._OnSimulatedResize(d,a,l),48)}_OnSimulatedResize(d,a,l){const m=this._GetWindowInnerWidth(),t=this._GetWindowInnerHeight();this._simulatedResizeTimerId=-1;m!=d||t!=a?this._PostRuntimeEvent("window-resize",{innerWidth:m,innerHeight:t,devicePixelRatio:window.devicePixelRatio,isFullscreen:p.IsDocumentFullscreen()}):10>l&&this._ScheduleSimulatedResize(m,t,l+1)}_OnSetTargetOrientation(d){this._targetOrientation=d.targetOrientation}_TrySetTargetOrientation(){const d=this._targetOrientation;if(screen.orientation&&
screen.orientation.lock)screen.orientation.lock(d).catch(a=>console.warn("[Construct 3] Failed to lock orientation: ",a));else try{let a=!1;screen.lockOrientation?a=screen.lockOrientation(d):screen.webkitLockOrientation?a=screen.webkitLockOrientation(d):screen.mozLockOrientation?a=screen.mozLockOrientation(d):screen.msLockOrientation&&(a=screen.msLockOrientation(d));a||console.warn("[Construct 3] Failed to lock orientation")}catch(a){console.warn("[Construct 3] Failed to lock orientation: ",a)}}_OnFullscreenChange(){const d=
p.IsDocumentFullscreen();d&&"any"!==this._targetOrientation&&this._TrySetTargetOrientation();this.PostToRuntime("fullscreenchange",{isFullscreen:d,innerWidth:this._GetWindowInnerWidth(),innerHeight:this._GetWindowInnerHeight()})}_OnFullscreenError(d){console.warn("[Construct 3] Fullscreen request failed: ",d);this.PostToRuntime("fullscreenerror",{isFullscreen:p.IsDocumentFullscreen(),innerWidth:this._GetWindowInnerWidth(),innerHeight:this._GetWindowInnerHeight()})}_OnVisibilityChange(d){d?this._iRuntime._CancelAnimationFrame():
this._iRuntime._RequestAnimationFrame();this.PostToRuntime("visibilitychange",{hidden:d})}_OnKeyEvent(d,a){"Backspace"===a.key&&r(a);const l=n.get(a.code)||a.code;this._PostToRuntimeMaybeSync(d,{code:l,key:a.key,which:a.which,repeat:a.repeat,altKey:a.altKey,ctrlKey:a.ctrlKey,metaKey:a.metaKey,shiftKey:a.shiftKey,timeStamp:a.timeStamp},u)}_OnMouseWheelEvent(d,a){this.PostToRuntime(d,{clientX:a.clientX,clientY:a.clientY,pageX:a.pageX,pageY:a.pageY,deltaX:a.deltaX,deltaY:a.deltaY,deltaZ:a.deltaZ,deltaMode:a.deltaMode,
timeStamp:a.timeStamp},u)}_OnMouseEvent(d,a,l){q(a)||this._PostToRuntimeMaybeSync(d,{button:a.button,buttons:a.buttons,clientX:a.clientX,clientY:a.clientY,pageX:a.pageX,pageY:a.pageY,timeStamp:a.timeStamp},l)}_OnMouseEventAsPointer(d,a){if(!q(a)){var l=this._mousePointerLastButtons;"pointerdown"===d&&0!==l?d="pointermove":"pointerup"===d&&0!==a.buttons&&(d="pointermove");this._PostToRuntimeMaybeSync(d,{pointerId:1,pointerType:"mouse",button:a.button,buttons:a.buttons,lastButtons:l,clientX:a.clientX,
clientY:a.clientY,pageX:a.pageX,pageY:a.pageY,width:0,height:0,pressure:0,tangentialPressure:0,tiltX:0,tiltY:0,twist:0,timeStamp:a.timeStamp},u);this._mousePointerLastButtons=a.buttons;this._OnMouseEvent(a.type,a,w)}}_OnPointerEvent(d,a){this._pointerRawUpdateRateLimiter&&"pointermove"!==d&&this._pointerRawUpdateRateLimiter.Reset();var l=0;"mouse"===a.pointerType&&(l=this._mousePointerLastButtons);this._PostToRuntimeMaybeSync(d,{pointerId:a.pointerId,pointerType:a.pointerType,button:a.button,buttons:a.buttons,
lastButtons:l,clientX:a.clientX,clientY:a.clientY,pageX:a.pageX,pageY:a.pageY,width:a.width||0,height:a.height||0,pressure:a.pressure||0,tangentialPressure:a.tangentialPressure||0,tiltX:a.tiltX||0,tiltY:a.tiltY||0,twist:a.twist||0,timeStamp:a.timeStamp},u);"mouse"===a.pointerType&&(l="mousemove","pointerdown"===d?l="mousedown":"pointerup"===d&&(l="mouseup"),this._OnMouseEvent(l,a,w),this._mousePointerLastButtons=a.buttons)}_OnPointerRawUpdate(d){this._lastPointerRawUpdateEvent=d;this._pointerRawUpdateRateLimiter.Call()}_DoSendPointerRawUpdate(){this._OnPointerEvent("pointermove",
this._lastPointerRawUpdateEvent);this._lastPointerRawUpdateEvent=null}_OnTouchEvent(d,a){for(let l=0,m=a.changedTouches.length;l<m;++l){const t=a.changedTouches[l];this._PostToRuntimeMaybeSync(d,{pointerId:t.identifier,pointerType:"touch",button:0,buttons:0,lastButtons:0,clientX:t.clientX,clientY:t.clientY,pageX:t.pageX,pageY:t.pageY,width:2*(t.radiusX||t.webkitRadiusX||0),height:2*(t.radiusY||t.webkitRadiusY||0),pressure:t.force||t.webkitForce||0,tangentialPressure:0,tiltX:0,tiltY:0,twist:t.rotationAngle||
0,timeStamp:a.timeStamp},u)}}_HandlePointerDownFocus(d){window!==window.top&&window.focus();this._IsElementCanvasOrDocument(d.target)&&document.activeElement&&!this._IsElementCanvasOrDocument(document.activeElement)&&document.activeElement.blur()}_IsElementCanvasOrDocument(d){return!d||d===document||d===window||d===document.body||"canvas"===d.tagName.toLowerCase()}_AttachDeviceOrientationEvent(){this._attachedDeviceOrientationEvent||(this._attachedDeviceOrientationEvent=!0,window.addEventListener("deviceorientation",
d=>this._OnDeviceOrientation(d)),window.addEventListener("deviceorientationabsolute",d=>this._OnDeviceOrientationAbsolute(d)))}_AttachDeviceMotionEvent(){this._attachedDeviceMotionEvent||(this._attachedDeviceMotionEvent=!0,window.addEventListener("devicemotion",d=>this._OnDeviceMotion(d)))}_OnDeviceOrientation(d){this.PostToRuntime("deviceorientation",{absolute:!!d.absolute,alpha:d.alpha||0,beta:d.beta||0,gamma:d.gamma||0,timeStamp:d.timeStamp,webkitCompassHeading:d.webkitCompassHeading,webkitCompassAccuracy:d.webkitCompassAccuracy},
u)}_OnDeviceOrientationAbsolute(d){this.PostToRuntime("deviceorientationabsolute",{absolute:!!d.absolute,alpha:d.alpha||0,beta:d.beta||0,gamma:d.gamma||0,timeStamp:d.timeStamp},u)}_OnDeviceMotion(d){let a=null;var l=d.acceleration;l&&(a={x:l.x||0,y:l.y||0,z:l.z||0});l=null;var m=d.accelerationIncludingGravity;m&&(l={x:m.x||0,y:m.y||0,z:m.z||0});m=null;const t=d.rotationRate;t&&(m={alpha:t.alpha||0,beta:t.beta||0,gamma:t.gamma||0});this.PostToRuntime("devicemotion",{acceleration:a,accelerationIncludingGravity:l,
rotationRate:m,interval:d.interval,timeStamp:d.timeStamp},u)}_OnUpdateCanvasSize(d){const a=this.GetRuntimeInterface().GetCanvas();a.style.width=d.styleWidth+"px";a.style.height=d.styleHeight+"px";a.style.marginLeft=d.marginLeft+"px";a.style.marginTop=d.marginTop+"px";this._isFirstSizeUpdate&&(a.style.display="",this._isFirstSizeUpdate=!1)}_OnInvokeDownload(d){const a=d.url;d=d.filename;const l=document.createElement("a"),m=document.body;l.textContent=d;l.href=a;l.download=d;m.appendChild(l);l.click();
m.removeChild(l)}async _OnRasterSvgImage(d){var a=d.imageBitmapOpts;d=await self.C3_RasterSvgImageBlob(d.blob,d.imageWidth,d.imageHeight,d.surfaceWidth,d.surfaceHeight);a=a?await createImageBitmap(d,a):await createImageBitmap(d);return{imageBitmap:a,transferables:[a]}}async _OnGetSvgImageSize(d){return await self.C3_GetSvgImageSize(d.blob)}async _OnAddStylesheet(d){await z(d.url)}_PlayPendingMedia(){var d=[...this._mediaPendingPlay];this._mediaPendingPlay.clear();if(!this._isSilent)for(const a of d)(d=
a.play())&&d.catch(l=>{this._mediaRemovedPendingPlay.has(a)||this._mediaPendingPlay.add(a)})}TryPlayMedia(d){if("function"!==typeof d.play)throw Error("missing play function");this._mediaRemovedPendingPlay.delete(d);let a;try{a=d.play()}catch(l){this._mediaPendingPlay.add(d);return}a&&a.catch(l=>{this._mediaRemovedPendingPlay.has(d)||this._mediaPendingPlay.add(d)})}RemovePendingPlay(d){this._mediaPendingPlay.delete(d);this._mediaRemovedPendingPlay.add(d)}SetSilent(d){this._isSilent=!!d}_OnHideCordovaSplash(){navigator.splashscreen&&
navigator.splashscreen.hide&&navigator.splashscreen.hide()}_OnDebugHighlight(d){if(d.show){this._debugHighlightElem||(this._debugHighlightElem=document.createElement("div"),this._debugHighlightElem.id="inspectOutline",document.body.appendChild(this._debugHighlightElem));var a=this._debugHighlightElem;a.style.display="";a.style.left=d.left-1+"px";a.style.top=d.top-1+"px";a.style.width=d.width+2+"px";a.style.height=d.height+2+"px";a.textContent=d.name}else this._debugHighlightElem&&(this._debugHighlightElem.style.display=
"none")}_OnRegisterSW(){window.C3_RegisterSW&&window.C3_RegisterSW()}_OnPostToDebugger(d){window.c3_postToMessagePort&&(d.from="runtime",window.c3_postToMessagePort(d))}_InvokeFunctionFromJS(d,a){return this.PostToRuntimeAsync("js-invoke-function",{name:d,params:a})}_OnAlert(d){alert(d.message)}_OnWrapperMessage(d){"entered-fullscreen"===d?(p._SetWrapperIsFullscreenFlag(!0),this._OnFullscreenChange()):"exited-fullscreen"===d?(p._SetWrapperIsFullscreenFlag(!1),this._OnFullscreenChange()):console.warn("Unknown wrapper message: ",
d)}})}"use strict";
self.JobSchedulerDOM=class{constructor(p){this._runtimeInterface=p;this._baseUrl=p.GetBaseURL();"preview"===p.GetExportType()?this._baseUrl+="c3/workers/":this._baseUrl+=p.GetScriptFolder();this._maxNumWorkers=Math.min(navigator.hardwareConcurrency||2,16);this._dispatchWorker=null;this._jobWorkers=[];this._outputPort=this._inputPort=null}async Init(){if(this._hasInitialised)throw Error("already initialised");this._hasInitialised=!0;var p=this._runtimeInterface._GetWorkerURL("dispatchworker.js");this._dispatchWorker=
await this._runtimeInterface.CreateWorker(p,this._baseUrl,{name:"DispatchWorker"});p=new MessageChannel;this._inputPort=p.port1;this._dispatchWorker.postMessage({type:"_init","in-port":p.port2},[p.port2]);this._outputPort=await this._CreateJobWorker()}async _CreateJobWorker(){const p=this._jobWorkers.length;var q=this._runtimeInterface._GetWorkerURL("jobworker.js");q=await this._runtimeInterface.CreateWorker(q,this._baseUrl,{name:"JobWorker"+p});const n=new MessageChannel,u=new MessageChannel;this._dispatchWorker.postMessage({type:"_addJobWorker",
port:n.port1},[n.port1]);q.postMessage({type:"init",number:p,"dispatch-port":n.port2,"output-port":u.port2},[n.port2,u.port2]);this._jobWorkers.push(q);return u.port1}GetPortData(){return{inputPort:this._inputPort,outputPort:this._outputPort,maxNumWorkers:this._maxNumWorkers}}GetPortTransferables(){return[this._inputPort,this._outputPort]}};"use strict";
window.C3_IsSupported&&(window.c3_runtimeInterface=new self.RuntimeInterface({useWorker:!1,workerMainUrl:"workermain.js",engineScripts:["scripts/c3runtime.js"],projectScripts:[],mainProjectScript:"",scriptFolder:"scripts/",workerDependencyScripts:[],exportType:"html5"}));"use strict";
{function p(n){n.stopPropagation()}function q(n){13!==n.which&&27!==n.which&&n.stopPropagation()}self.RuntimeInterface.AddDOMHandlerClass(class extends self.DOMElementHandler{constructor(n){super(n,"text-input");this.AddDOMElementMessageHandler("scroll-to-bottom",u=>this._OnScrollToBottom(u))}CreateElement(n,u){let w;const E=u.type;"textarea"===E?(w=document.createElement("textarea"),w.style.resize="none"):(w=document.createElement("input"),w.type=E);w.style.position="absolute";w.autocomplete="off";
w.addEventListener("touchstart",p);w.addEventListener("touchmove",p);w.addEventListener("touchend",p);w.addEventListener("mousedown",p);w.addEventListener("mouseup",p);w.addEventListener("keydown",q);w.addEventListener("keyup",q);w.addEventListener("click",z=>{z.stopPropagation();this._PostToRuntimeElementMaybeSync("click",n)});w.addEventListener("dblclick",z=>{z.stopPropagation();this._PostToRuntimeElementMaybeSync("dblclick",n)});w.addEventListener("input",()=>this.PostToRuntimeElement("change",
n,{text:w.value}));u.id&&(w.id=u.id);this.UpdateState(w,u);return w}UpdateState(n,u){n.value=u.text;n.placeholder=u.placeholder;n.title=u.title;n.disabled=!u.isEnabled;n.readOnly=u.isReadOnly;n.spellcheck=u.spellCheck;u=u.maxLength;0>u?n.removeAttribute("maxlength"):n.setAttribute("maxlength",u)}_OnScrollToBottom(n){n.scrollTop=n.scrollHeight}})}"use strict";
{function p(q){q.stopPropagation()}self.RuntimeInterface.AddDOMHandlerClass(class extends self.DOMElementHandler{constructor(q){super(q,"button")}CreateElement(q,n){const u=document.createElement("input");var w=u;n.isCheckbox?(u.type="checkbox",w=document.createElement("label"),w.appendChild(u),w.appendChild(document.createTextNode("")),w.style.fontFamily="sans-serif",w.style.userSelect="none",w.style.webkitUserSelect="none",w.style.display="inline-block",w.style.color="black"):u.type="button";w.style.position=
"absolute";w.addEventListener("touchstart",p);w.addEventListener("touchmove",p);w.addEventListener("touchend",p);w.addEventListener("mousedown",p);w.addEventListener("mouseup",p);w.addEventListener("keydown",p);w.addEventListener("keyup",p);u.addEventListener("click",()=>this._PostToRuntimeElementMaybeSync("click",q,{isChecked:u.checked}));n.id&&(u.id=n.id);this.UpdateState(w,n);return w}_GetInputElem(q){return"input"===q.tagName.toLowerCase()?q:q.firstChild}_GetFocusElement(q){return this._GetInputElem(q)}UpdateState(q,
n){const u=this._GetInputElem(q);u.checked=n.isChecked;u.disabled=!n.isEnabled;q.title=n.title;q===u?u.value=n.text:q.lastChild.textContent=n.text}})}"use strict";
{function p(q){q.stopPropagation()}self.RuntimeInterface.AddDOMHandlerClass(class extends self.DOMElementHandler{constructor(q){super(q,"list");this.AddDOMElementMessageHandler("set-selected-index",(n,u)=>this._OnSetSelectedIndex(n,u.selectedIndex));this.AddDOMElementMessageHandler("add-item",(n,u)=>this._OnAddItem(n,u));this.AddDOMElementMessageHandler("remove-item",(n,u)=>this._OnRemoveItem(n,u));this.AddDOMElementMessageHandler("set-item",(n,u)=>this._OnSetItem(n,u));this.AddDOMElementMessageHandler("clear",
n=>this._OnClear(n));this.AddDOMElementMessageHandler("load-state",(n,u)=>this._OnLoadState(n,u))}CreateElement(q,n){const u=n.isDropdown,w=n.isMultiSelect,E=n.items,z=document.createElement("select");z.style.position="absolute";z.style.userSelect="none";z.style.webkitUserSelect="none";z.multiple=w;u||(z.size=2);for(const f of E)z.add(this._CreateOption(f));z.addEventListener("touchstart",p);z.addEventListener("touchmove",p);z.addEventListener("touchend",p);z.addEventListener("mousedown",p);z.addEventListener("mouseup",
p);z.addEventListener("click",f=>{f.stopPropagation();this._PostToRuntimeElementMaybeSync("click",q,this._GetSelectionState(z))});z.addEventListener("dblclick",f=>{f.stopPropagation();this._PostToRuntimeElementMaybeSync("dblclick",q,this._GetSelectionState(z))});z.addEventListener("change",()=>this.PostToRuntimeElement("change",q,this._GetSelectionState(z)));n.id&&(z.id=n.id);this.UpdateState(z,n);return z}_CreateOption(q){const n=document.createElement("option");n.text=q;return n}_GetSelectionState(q){const n=
q.selectedIndex,u=[];for(let w=0,E=q.length;w<E;++w)q.options[w].selected&&u.push(w);return{selectedIndex:n,selectedIndices:u}}UpdateState(q,n){q.title=n.title;q.disabled=!n.isEnabled;q.multiple=!!n.isMultiSelect}_OnSetSelectedIndex(q,n){q.selectedIndex=n}_OnAddItem(q,n){const u=n.index;n=this._CreateOption(n.text);0>u?q.add(n):q.add(n,u)}_OnRemoveItem(q,n){q.remove(n.index)}_OnSetItem(q,n){q.options[n.index].text=n.text}_OnClear(q){q.innerHTML=""}_OnLoadState(q,n){q.innerHTML="";for(const u of n.items)q.add(this._CreateOption(u));
q.selectedIndex=n.selectedIndex;for(const u of n.selectedIndices)if(n=q.options[u])n.selected=!0}})}"use strict";
{const p=[],q=2*Math.PI;function n(e){e%=q;0>e&&(e+=q);return e}function u(e,k,r){return e<k?k:e>r?r:e}function w(e,k,r){return e+r*(k-e)}function E(e,k,r){return e===k?0:(r-e)/(k-e)}function z(e,k){if(e===k)return 0;e=Math.sin(e)*Math.sin(k)+Math.cos(e)*Math.cos(k);return 1<=e?0:-1>=e?Math.PI:Math.acos(e)}function f(e,k){return 0>=Math.cos(e)*Math.sin(k)-Math.sin(e)*Math.cos(k)}function h(e,k,r){const x=z(e,k);return f(k,e)?n(e+x*r):n(e-x*r)}class b{constructor(e,k,r,x,y,D){this._index=e;this._interp=
k;this._precision=r;this._tag=x;this._userData=y;this._clientValueTag=D}GetRuntimeData(){return{tag:this._tag,interp:this._interp,userData:this._userData,cvt:this._clientValueTag}}GetIndex(){return this._index}GetInterp(){return this._interp}GetPrecision(){return this._precision}GetTag(){return this._tag}HasUserData(){return"undefined"!==typeof this._userData}GetUserData(){return this._userData}GetClientValueTag(){return this._clientValueTag}Clamp(e){switch(this._precision){case 0:return e;case 1:return Math.fround(e);
case 2:return 2===this._interp&&(e=n(e),e/=Math.PI,e=32767*(e-1)),u(e|0,-32768,32767);case 3:return 2===this._interp&&(e=n(e),e/=q,e*=255),u(e|0,0,255);default:return e}}Write(e,k,r){switch(this._precision){case 0:e.setFloat64(k,r);k+=8;break;case 1:e.setFloat32(k,r);k+=4;break;case 2:e.setInt16(k,r);k+=2;break;case 3:e.setUint8(k,r);k+=1;break;default:e.setFloat32(k,r),k+=4}return k}MaybeUnpack(e){if(2!==this._interp)return e;2===this._precision?e=(e/32767+1)*Math.PI:3===this._precision&&(e=e/255*
q);return e}static InterpNetValue(e,k,r,x,y){switch(e){case 0:return y?r:k;case 1:return w(k,r,x);case 2:return h(k,r,x);default:return y?r:k}}}class c{constructor(e,k){this.timestamp=e;this.data=k}}class g{constructor(e,k,r){this._ro=e;this._domHandler=e.GetDOMHandler();this._id=k;this._nid=r;this._data=[];this._data.length=this._ro.GetNetValues().length;this._lastTransmitted=this._lastChanged=0;this._isAlive=this._transmitMe=!1;this._updates=[];this._nextUpdate=this._priorUpdate=this._priorUpdate2=
null}GetRuntimeData(){var e=[];for(let r=0,x=this._ro.GetNetValues().length;r<x;++r)e.push(this.GetInterp(this._ro.GetSimTime(),r));e={id:this._id,nid:this._nid,isTimedOut:this.IsTimedOut(),interpValues:e,latestUpdate:null};const k=this.GetLatestUpdate();k&&(e.latestUpdate={timestamp:k.timestamp,data:k.data});return e}GetId(){return this._id}GetNid(){return this._nid}SetAlive(e){this._isAlive=!!e}IsAlive(){return this._isAlive}ShouldTransmit(){return this._transmitMe}UpdateData(e,k){e=e.netValues;
var r=this._ro.GetNetValues();const x=r.length;this._transmitMe=!1;for(let y=0;y<x;++y){const D=r[y].Clamp(e[y]);this._data[y]!==D&&(this._data[y]=D,this._lastChanged=k,this._ro.SetLastChanged(k))}e=k-this._lastChanged;k-=this._lastTransmitted;r=this._ro.GetBandwidth();(this._transmitMe=100>e&&0===r?!0:1E3>e&&1>=r?95<=k:495<=k)&&this._ro.IncNumberToTransmit()}WriteData(e,k,r){const x=this._ro.GetNetValues();this._lastTransmitted=r;e.setUint16(k,this._nid);k+=2;for(let y=0,D=this._data.length;y<D;++y)k=
x[y].Write(e,k,this._data[y]);return k}AddUpdate(e,k){for(let r=0,x=this._updates.length;r<x;++r){const y=this._updates[r];if(y.timestamp===e)return;if(y.timestamp>e){this._updates.splice(r,0,new c(e,k));return}}this._updates.push(new c(e,k))}IsTimedOut(){return 0===this._updates.length?!1:this._updates[this._updates.length-1].timestamp<this._ro.GetSimTime()-3E3}Tick(){for(;2<this._updates.length&&this._updates[0]!==this._priorUpdate2&&this._updates[0]!==this._priorUpdate&&this._updates[0]!==this._nextUpdate;)this._updates.shift();
const e=this._ro.GetSimTime();if(!(this._nextUpdate&&this._nextUpdate.timestamp>e&&this._priorUpdate&&this._priorUpdate.timestamp<e)){this._nextUpdate=null;for(let k=0,r=this._updates.length;k<r;++k){const x=this._updates[k];if(x.timestamp<=e){if(!this._priorUpdate||x.timestamp>this._priorUpdate.timestamp)this._priorUpdate2=this._priorUpdate,this._priorUpdate=x}else{this._nextUpdate=x;break}}}}GetLatestUpdate(){return 0===this._updates.length?null:this._updates[this._updates.length-1]}GetInterp(e,
k,r){if(!this._nextUpdate&&!this._priorUpdate)return 0;if(this._nextUpdate&&!this._priorUpdate)return this._nextUpdate.data[k];const x=this._ro.GetNetValues();let y,D,G;if(!this._nextUpdate&&this._priorUpdate)return this._priorUpdate2&&!r?(y=this._priorUpdate2.timestamp,r=this._priorUpdate2.data[k],D=this._priorUpdate.timestamp,G=this._priorUpdate.data[k],e>this._priorUpdate.timestamp+this._ro.GetExtrapolateLimit()&&(e=this._priorUpdate.timestamp+this._ro.GetExtrapolateLimit()),e=E(y,D,e),b.InterpNetValue(x[k].GetInterp(),
r,G,e,!0)):this._priorUpdate.data[k];y=this._priorUpdate.timestamp;r=this._priorUpdate.data[k];D=this._nextUpdate.timestamp;G=this._nextUpdate.data[k];e=E(y,D,e);return b.InterpNetValue(x[k].GetInterp(),r,G,e,!1)}}class v{constructor(e,k,r,x){this._domHandler=e;this._roId=k;this._sid=r;this._nid=this._domHandler.GetNextObjectNid();this._bandwidth=x;this._userData={};this._instanceByteSize=0;this._extrapolateLimit=250;switch(this._bandwidth){case 1:this._extrapolateLimit=500;break;case 2:this._extrapolateLimit=
2500}this._netValues=[];this._netInstances=[];this._idToNetInst=new Map;this._usedNids=new Set;this._numberToTransmit=this._lastTransmitted=this._lastChanged=this._nextNid=0;this._hasOverriddenNids=!1;this._deadNids=[];this._overrideNids=new Map;this._nidToNetInst=new Map;this._simTime=0;this._domHandler.AddRegisteredObject(this)}GetDOMHandler(){return this._domHandler}GetNetValues(){return this._netValues}GetRoId(){return this._roId}_SetNid(e){this._nid=e}GetNid(){return this._nid}SetLastChanged(e){this._lastChanged=
e}GetBandwidth(){return this._bandwidth}IncNumberToTransmit(){this._numberToTransmit++}GetNumberToTransmit(){return this._numberToTransmit}GetSimTime(){return this._simTime}_SetHasOverriddenNids(e){this._hasOverriddenNids=!!e}HasOverriddenNids(){return this._hasOverriddenNids}GetExtrapolateLimit(){return this._extrapolateLimit}GetSid(){return this._sid}GetDeadNids(){return this._deadNids}AddValue(e,k,r,x,y){e=new b(this._netValues.length,e,k,r,x,y);switch(k){case 0:this._instanceByteSize+=8;break;
case 1:this._instanceByteSize+=4;break;case 2:this._instanceByteSize+=2;break;case 3:this._instanceByteSize+=1}this._netValues.push(e)}AddUpdate(e,k,r){this.GetNetInstForNid(k).AddUpdate(e,r)}Tick(){this._simTime=this._domHandler.GetSimulationTime();for(const e of this._netInstances)e.Tick()}GetCount(){return this._netInstances.length}GetNetInstAt(e){e=Math.floor(e);return 0>e||e>=this._netInstances.length?null:this._netInstances[e]}GetNetInstByNid(e){for(const k of this._netInstances)if(k.GetNid()===
e)return k;return null}GetNetValuesJson(){const e=[];for(const k of this._netValues){const r={tag:k.GetTag(),precision:k.GetPrecision(),interp:k.GetInterp(),clientvaluetag:k.GetClientValueTag()};k.HasUserData()&&(r.userdata=k.GetUserData());e.push(r)}return e}SetNetValuesFrom(e){this._instanceByteSize=this._netValues.length=0;for(const k of e)this.AddValue(k.interp,k.precision,k.tag,k.userdata,k.clientvaluetag)}GetNetInstForNid(e){let k=this._nidToNetInst.get(e);if(k)return k;k=new g(this,-1,e);this._nidToNetInst.set(e,
k);this._netInstances.push(k);return k}GetNetInstForId(e){let k=this._idToNetInst.get(e);if(k)return k;k=new g(this,e,this.AllocateInstanceNid());this._idToNetInst.set(e,k);this._netInstances.push(k);return k}AllocateInstanceNid(){do this._nextNid++,65535<this._nextNid&&(this._nextNid=0);while(this._usedNids.has(this._nextNid));const e=this._nextNid;this._usedNids.add(e);return e}RemoveNetInstance(e){const k=e.GetId(),r=e.GetNid();this._domHandler.IsHost()&&!this._hasOverriddenNids&&this._deadNids.push(r);
this._idToNetInst.delete(k);this._nidToNetInst.delete(r);this._usedNids.delete(r);e=this._netInstances.indexOf(e);-1<e&&this._netInstances.splice(e,1)}ClearAllNetInstances(){this._deadNids.length=0;this._idToNetInst.clear();this._nidToNetInst.clear();this._usedNids.clear();this._netInstances.length=0}UpdateData(e,k){this._numberToTransmit=0;for(var r of this._netInstances)r.SetAlive(!1);for(let x=0,y=e.length;x<y;++x){r=e[x];const D=this.GetNetInstForId(r.uid);D.SetAlive(!0);D.UpdateData(r,k)}for(const x of this._netInstances)x.IsAlive()||
p.push(x);for(const x of p)this.RemoveNetInstance(x);p.length=0}WriteData(e,k,r){e.setUint16(k,this._nid);k+=2;let x=0;this._hasOverriddenNids&&(x=1);e.setUint8(k,x);k+=1;e.setUint16(k,this._numberToTransmit);k+=2;e.setUint16(k,this._instanceByteSize);k+=2;for(const y of this._netInstances)y.ShouldTransmit()&&(k=y.WriteData(e,k,r));return k}OverrideNid(e,k){if(this._idToNetInst.has(e))console.warn("OverrideNid passed id "+e+" which is already in use and cannot be overridden");else if(this._usedNids.has(k))console.warn("OverrideNid passed nid "+
k+" which is already in use and cannot be overridden");else{var r=new g(this,e,k);this._idToNetInst.set(e,r);this._usedNids.add(k);this._netInstances.push(r);this._hasOverriddenNids=!0;return r}}RemoveObjectId(e){(e=this._idToNetInst.get(e))&&this.RemoveNetInstance(e)}RemoveObjectNid(e){(e=this._nidToNetInst.get(e))&&this.RemoveNetInstance(e)}GetRuntimeData(){return{hasOverriddenNids:this.HasOverriddenNids(),netValues:this._netValues.map(e=>e.GetRuntimeData()),netInstances:this._netInstances.map(e=>
e.GetRuntimeData())}}GetRuntimeInfoRequest(){return{roId:this._roId,sid:this._sid,netValues:this._netValues.map(e=>e.GetRuntimeData())}}}self.C3NetValue=b;self.C3NetUpdate=c;self.C3RegisteredObject=v}"use strict";
{const p=self.C3NetUpdate,q=self.C3NetValue,n=window.RTCPeerConnection||window.webkitRTCPeerConnection||window.mozRTCPeerConnection||window.msRTCPeerConnection;function u(f){if(f)try{f.close()}catch(h){}}const w=[];function E(f,h,b){return f===h?0:(b-f)/(h-f)}class z{constructor(f,h,b){this._domHandler=f;this._id=h;this._nid=0;this._alias=b;this._dco=this._pc=null;this._isOOpen=!1;this._dcr=null;this._isROpen=!1;this._dcu=null;this._hasConfirmed=this._wasRemoved=this._firedClose=this._firedOpen=this._isUOpen=
!1;this._errorCount=this._connectTime=this._lastHeardFrom=0;this._localClientState=[];this._lastStateTransmit=this._lastStateChange=0;this._clientStateUpdates=[];this._nextUpdate=this._priorUpdate=this._priorUpdate2=null;this._lastPingSent=0;this._awaitingPong=!1;this._lastSentPingId=1;this._lastPingTimes=[];this._pdv=this._latency=0;this._domHandler._AddPeer(this)}GetId(){return this._id}GetNid(){return this._nid}_SetNid(f){this._nid=f}GetAlias(){return this._alias}IsHost(){return this===this._domHandler.GetHostPeer()}IsSelf(){return this===
this._domHandler.GetSelfPeer()}GetLocalClientState(){return this._localClientState}_SetLastStateChange(f){this._lastStateChange=f}GetLastStateChange(){return this._lastStateChange}_SetLastStateTransmit(f){this._lastStateTransmit=f}GetLastStateTransmit(){return this._lastStateTransmit}GetLatency(){return this._latency}GetPdv(){return this._pdv}_AttachDataChannelHandlers(f,h){f.binaryType="arraybuffer";f.onopen=()=>{"o"===h?this._isOOpen=!0:"r"===h?this._isROpen=!0:"u"===h&&(this._isUOpen=!0);this._MaybeFireOpen()};
f.onmessage=b=>{this._OnMessage(h,b)};f.onerror=b=>{console.error("Peer '"+this._id+"' datachannel '"+h+"' error: ",b);this._domHandler._OnPeerError(this,b);this._domHandler.IsHost()&&!this.IsHost()&&this.Remove("network error")};f.onclose=()=>{this.Remove("disconnect")}}Connect(){if(!this.IsSelf()){var f=this._domHandler.IsHost();this._firedClose=this._firedOpen=this._isUOpen=this._isROpen=this._isOOpen=!1;this._connectTime=performance.now();this._pc=new n({iceServers:this._domHandler.GetICEServerList()});
this._pc.onicecandidate=b=>{b.candidate&&this._domHandler.SignallingSend({message:"icecandidate",toclientid:this._id,icecandidate:b.candidate})};this._pc.onsignalingstatechange=()=>{this._pc&&"closed"===this._pc.signalingState&&this.Remove("disconnect")};this._pc.oniceconnectionstatechange=()=>{this._pc&&("failed"!==this._pc.iceConnectionState&&"closed"!==this._pc.iceConnectionState||this.Remove("disconnect"))};this._pc.onconnectionstatechange=()=>{if(this._pc){var b=this._pc.connectionState;"failed"!==
b&&"closed"!==b||this.Remove("disconnect")}};var h=`c2mp_${this._domHandler.GetCurrentGame()}_${this._domHandler.GetCurrentGameInstance()}_${this._domHandler.GetCurrentRoom()}`;f?(this._nid=this._domHandler.AllocatePeerNid(),this._dco=this._pc.createDataChannel("o",{ordered:!0,protocol:h}),this._AttachDataChannelHandlers(this._dco,"o"),this._dcr=this._pc.createDataChannel("r",{ordered:!1,protocol:h}),this._AttachDataChannelHandlers(this._dcr,"r"),this._dcu=this._pc.createDataChannel("u",{ordered:!1,
maxRetransmits:0,protocol:h}),this._AttachDataChannelHandlers(this._dcu,"u"),this._pc.createOffer().then(b=>{this._pc.setLocalDescription(b);this._domHandler.SignallingSend({message:"offer",toclientid:this._id,offer:b})}).catch(b=>{console.error("Host error creating offer for peer '"+this._id+"': ",b);this._domHandler._OnPeerError(this,"could not create offer for peer")})):this._pc.ondatachannel=b=>{if(b.channel.protocol!==h)console.error("Unexpected datachannel protocol '"+b.channel.protocol+"', should be '"+
h+"'"),this._domHandler._OnPeerError(this,"unexpected datachannel protocol '"+b.channel.protocol+"', should be '"+h+"'");else{var c=b.channel.label;"o"===c?this._dco=b.channel:"r"===c?this._dcr=b.channel:"u"===c?this._dcu=b.channel:(console.error("Unknown datachannel label: "+b.channel.label),this._domHandler._OnPeerError(this,"unknown datachannel label '"+b.channel.label+"'"));this._AttachDataChannelHandlers(b.channel,c)}}}}async _AddICECandidate(f){if(this._pc)try{await this._pc.addIceCandidate(f)}catch(h){console.warn("[Multiplayer] Error adding ICE candidate: ",
h)}}HasPeerConnection(){return!!this._pc}GetPeerConnection(){return this._pc}_MaybeFireOpen(){!this._firedOpen&&this._isROpen&&this._isUOpen&&this._isOOpen&&(this._OnOpen(),this._firedOpen=!0,this._firedClose=!1)}_OnOpen(){this._lastHeardFrom=performance.now();if(this._domHandler.IsHost()){this._domHandler.HostBroadcast("o",JSON.stringify({c:"j",i:this._id,n:this._nid,a:this._alias}),this);this.Send("o",JSON.stringify({c:"hi",hn:this._domHandler.GetHostPeer().GetNid(),n:this._nid,d:this._domHandler.GetClientDelay(),
u:this._domHandler.GetPeerUpdateRateSec(),objs:this._domHandler.GetRegisteredObjectsMap(),cvs:this._domHandler.GetClientValuesJson()}));for(const f of this._domHandler.peers())!f.IsHost()&&f!==this&&f.IsOpen()&&this.Send("o",JSON.stringify({c:"j",i:f.GetId(),n:f.GetNid(),a:f.GetAlias()}))}else this._hasConfirmed=!0,this.IsHost()&&this.SendPing(performance.now(),!0);this._domHandler._OnPeerOpen(this)}_MaybeFireClose(f){!this._firedClose&&this._firedOpen&&(this._OnClose(f),this._firedClose=!0,this._firedOpen=
!1)}_OnClose(f){this._domHandler.IsHost()&&!this.IsSelf()&&this._domHandler.HostBroadcast("o",JSON.stringify({c:"l",i:this._id,a:this._alias,r:f}),this);this.IsSelf()||this._domHandler._OnPeerClose(this,f)}IsOpen(){return this._firedOpen&&!this._firedClose}Send(f,h){this._domHandler.StatIncOutboundCount();var b=0;h.length?b=h.length:h.byteLength&&(b=h.byteLength);this._domHandler.StatAddOutboundBandwidthCount(b);b=this._domHandler.GetSimulatedPacketLoss();const c=this._domHandler.GetSimulatedLatency(),
g=this._domHandler.GetSimulatedPdv();if(!(0<b&&"u"===f&&Math.random()<b))if(0===c&&0===g)this._DoSend(f,h);else{let v=1;"u"!==f&&Math.random()<b&&(v=3);setTimeout(()=>this._DoSend(f,h),c*v+Math.random()*g*v)}}_DoSend(f,h){try{"o"===f?this._isOOpen&&this._dco&&this._dco.send(h):"r"===f?this._isROpen&&this._dcr&&this._dcr.send(h):"u"===f&&this._isUOpen&&this._dcu&&this._dcu.send(h)}catch(b){this._wasRemoved||(this._domHandler.IsHost()?"o"===f||"r"===f?("string"===typeof h?(console.error("Error sending "+
h.length+"-char string on '"+f+"' to '"+this._alias+"', host kicking: ",b),console.log("String that failed to send from previous error was: "+h)):console.error("Error sending "+(h.length||h.byteLength)+"-byte binary on '"+f+"' to '"+this._alias+"', host kicking: ",b),this.Remove("network error")):(this._errorCount++,10<=this._errorCount&&("string"===typeof h?(console.error("Too many errors ("+this._errorCount+") sending data on '"+f+"' to '"+this._alias+"', kicking; last error was for sending "+h.length+
"-char string: ",b),console.log("String that failed to send from previous error was: "+h)):console.error("Too many errors ("+this._errorCount+") sending data on '"+f+"' to '"+this._alias+"', kicking; last error was for sending "+(h.length||h.byteLength)+"-byte binary: ",b),this.Remove("network error"))):console.error("Error sending data on '"+f+"': ",b))}}SendPing(f,h){this._wasRemoved||(!h&&!this.IsOpen()&&this._pc&&25E3<f-this._connectTime?(console.warn("Timed out '"+this._alias+"', could not establish connection after 25sec"),
this.Remove("timeout")):!h&&this.IsOpen()&&2E4<f-this._lastHeardFrom?(console.warn("Timed out '"+this._alias+"', not heard from for 20sec"),this.Remove("timeout")):(this._lastPingSent=f,this._awaitingPong=!0,this._lastSentPingId++,this.Send("u","ping:"+this._lastSentPingId)))}SendPong(f){f="pong:"+f.substr(5);this._domHandler.IsHost()&&(f=f+"/"+Math.round(performance.now()).toString());this.Send("u",f)}_OnPong(f){if(this._awaitingPong){var h=f.indexOf(":");if(-1<h){if(parseFloat(f.substr(h+1))===
this._lastSentPingId){h=performance.now();this._awaitingPong=!1;var b=(h-this._lastPingSent)/2;this._lastPingTimes.push(b);10<this._lastPingTimes.length&&this._lastPingTimes.shift();w.push(...this._lastPingTimes);w.sort((e,k)=>e-k);this._pdv=w[w.length-1]-w[0];var c=0,g=w.length;4<=w.length&&6>=w.length?(++c,--g):6<w.length&&(c+=2,g-=2);var v=0;for(let e=c;e<g;++e)v+=w[e];this._latency=v/(g-c);w.length=0;this._domHandler.IsHost()||(c=f.indexOf("/"),-1<c?(f=parseFloat(f.substr(c+1)),isFinite(f)?this._domHandler.AddHostTime(f,
h,b,this._latency):console.warn("Invalid host time from pong response")):console.warn("Cannot parse off host time from pong response"))}}else console.warn("Cannot parse off ping ID from pong")}}_OnMessage(f,h){const b=this._domHandler.GetSimulatedPacketLoss(),c=this._domHandler.GetSimulatedLatency(),g=this._domHandler.GetSimulatedPdv();if(!(0<b&&"u"===f&&Math.random()<b))if(0===c&&0===g)this._DoOnMessage(f,h);else{let v=1;"u"!==f&&Math.random()<b&&(v=3);setTimeout(()=>this._DoOnMessage(f,h),c*v+Math.random()*
g*v)}}_DoOnMessage(f,h){if(!this._wasRemoved){this._lastHeardFrom=performance.now();this._domHandler.StatIncInboundCount();var b=0;h.data.length?b=h.data.length:h.data.byteLength&&(b=h.data.byteLength);this._domHandler.StatAddInboundBandwidthCount(b);if("string"===typeof h.data){if(!(""===h.data.trim()||4>h.data.length))if(f=h.data.substr(0,4),"ping"===f)this.SendPong(h.data);else if("pong"===f)this._OnPong(h.data);else{try{var c=JSON.parse(h.data)}catch(g){this._domHandler._OnPeerError(this,g);this._domHandler.IsHost()?
(console.error("Error parsing message as JSON for peer '"+this._id+"', host kicking: ",g),this.Remove("data error")):console.error("Error parsing message as JSON for peer '"+this._id+"': ",g);console.log("String that failed to parse from previous error: "+h.data);return}if(c)try{c.c&&"m"!==c.c?this._OnControlMessage(c):this._domHandler._OnPeerMessage(this,c)}catch(g){this._domHandler._OnPeerError(this,g),this._domHandler.IsHost()?(console.error("Error handling message for peer '"+this._id+"', host kicking: ",
g),this.Remove("data error")):console.error("Error handling message for peer '"+this._id+"': ",g)}}}else{!this._hasConfirmed&&this._domHandler.IsHost()&&"u"===f&&(this._hasConfirmed=!0,this._domHandler.SignallingConfirmPeer(this._id));try{this._OnBinaryMessage(h.data)}catch(g){this._domHandler._OnPeerError(this,g),this._domHandler.IsHost()?(console.error("Error handling binary update for peer '"+this._id+"', host kicking: ",g),this.Remove("data error")):console.error("Error handling binary update for peer '"+
this._id+"': ",g)}}}}_OnControlMessage(f){switch(f.c){case "disconnect":f.k&&this._domHandler.PostToRuntime("peer-kicked");var h=!this._domHandler.IsHost()&&!this.IsHost();this.Remove(f.r);h&&this._domHandler.SignallingLeaveRoom();break;case "hi":this._domHandler.IsHost()||(this._domHandler.GetHostPeer()._SetNid(f.hn),this._domHandler.GetSelfPeer()._SetNid(f.n),this._domHandler.SetClientDelay(f.d),this._domHandler.SetPeerUpdateRateSec(f.u),this._domHandler.MapObjectNids(f.objs),this._domHandler.MapClientValues(f.cvs));
break;case "j":this._domHandler.IsHost()||(h=new z(this._domHandler,f.i,f.a),h._SetNid(f.n),this._domHandler._OnPeerOpen(h));break;case "l":!this._domHandler.IsHost()&&(h=this._domHandler.GetPeerById(f.i))&&(h.IsSelf()||this._domHandler._OnPeerClose(h,f.r),h.Remove(f.r));break;default:console.error("Unknown control message from peer '"+this._id+"': "+f.c),this._domHandler._OnPeerError(this,"unknown control message '"+f.c+"'")}}_OnBinaryMessage(f){this._domHandler.IsHost()?this._OnHostUpdate(f):this._OnPeerUpdate(f)}_OnHostUpdate(f){f=
new DataView(f);let h=0;var b=f.getUint32(h);h+=4;if(1664249200!==b)console.warn("Rejected packet with incorrect magic number (received '"+b+"', expected '1664249200'");else if(b=f.getFloat64(h),h+=8,b+=this._latency,!(3E3<=Math.abs(b-performance.now()))){f.getUint8(h);h+=1;var c=f.getUint8(h);h+=1;var g=[],v=this._domHandler.GetClientValues();for(let k=0;k<c;++k)if(k>=v.length)g.push(0);else{var e=v[k];switch(e.GetPrecision()){case 0:e=f.getFloat64(h);h+=8;break;case 1:e=f.getFloat32(h);h+=4;break;
case 2:e=e.MaybeUnpack(f.getInt16(h));h+=2;break;case 3:e=e.MaybeUnpack(f.getUint8(h));h+=1;break;default:e=f.getFloat32(h),h+=4}g.push(e)}this._AddClientUpdate(b,g)}}_AddClientUpdate(f,h){for(let b=0,c=this._clientStateUpdates.length;b<c;++b){const g=this._clientStateUpdates[b];if(g.timestamp===f)return;if(g.timestamp>f){this._clientStateUpdates.splice(b,0,new p(f,h));return}}this._clientStateUpdates.push(new p(f,h))}Tick(f){if(0!==this._clientStateUpdates.length){for(;2<this._clientStateUpdates.length&&
this._clientStateUpdates[0]!==this._priorUpdate2&&this._clientStateUpdates[0]!==this._priorUpdate&&this._clientStateUpdates[0]!==this._nextUpdate;)this._clientStateUpdates.shift();if(!(this._nextUpdate&&this._nextUpdate.timestamp>f&&this._priorUpdate&&this._priorUpdate.timestamp<f)){this._nextUpdate=null;for(let h=0,b=this._clientStateUpdates.length;h<b;++h){const c=this._clientStateUpdates[h];if(c.timestamp<=f){if(!this._priorUpdate||c.timestamp>this._priorUpdate.timestamp)this._priorUpdate2=this._priorUpdate,
this._priorUpdate=c}else{this._nextUpdate=c;break}}}}}_OnPeerUpdate(f){f=new DataView(f);let h=0;var b=f.getUint32(h);h+=4;1664249200!==b?console.warn("Rejected packet with incorrect magic number (received '"+b+"', expected '1664249200'"):(b=f.getUint32(h),h+=4,0===b?this._HandlePeerUpdate(f,h):1===b?this._HandlePeerEvents(f,h):console.warn("Ignoring packet with incorrect flags (received "+b+", expected 0 or 1"))}_HandlePeerUpdate(f,h){const b=f.getFloat64(h);h+=8;const c=f.getUint16(h);h+=2;for(let k=
0;k<c;++k){var g=f.getUint16(h);h+=2;var v=f.getUint8(h);h+=1;let r=null,x=0;const y=this._domHandler.GetRegisteredObjectByNid(g);y?(r=y.GetNetValues(),x=r.length,1===v&&y._SetHasOverriddenNids(!0)):console.warn("Don't know which object corresponds to NID "+g);g=f.getUint16(h);h+=2;v=f.getUint16(h);h+=2;for(let D=0;D<g;++D){const G=f.getUint16(h);h+=2;if(y){const d=[];let a=h;for(let l=0;l<x;++l){var e=r[l];switch(e.GetPrecision()){case 0:e=f.getFloat64(a);a+=8;break;case 1:e=f.getFloat32(a);a+=4;
break;case 2:e=e.MaybeUnpack(f.getInt16(a));a+=2;break;case 3:e=e.MaybeUnpack(f.getUint8(a));a+=1;break;default:e=f.getFloat32(a),a+=4}d.push(e)}y.AddUpdate(b,G,d)}h+=v}}}_HandlePeerEvents(f,h){const b=f.getFloat64(h);h+=8;const c=f.getUint16(h);h+=2;for(let v=0;v<c;++v){var g=f.getUint16(h);h+=2;const e=this._domHandler.GetRegisteredObjectByNid(g);e||console.warn("Don't know which object corresponds to NID "+g);g=f.getUint16(h);h+=2;for(let k=0;k<g;++k){const r=f.getUint16(h);h+=2;e&&!e.HasOverriddenNids()&&
(this._domHandler._OnInstanceDestroyed(e,r,b),e.RemoveObjectNid(r))}}}Remove(f,h){if(!this._wasRemoved){this._wasRemoved=!0;this._MaybeFireClose(f);this.Send("o",JSON.stringify({c:"disconnect",r:f,k:!!h}));var b=this._dco,c=this._dcr,g=this._dcu,v=this._pc;setTimeout(()=>{u(b);u(c);u(g);u(v)},0);this._pc=this._dcu=this._dcr=this._dco=null;this._isUOpen=this._isROpen=this._isOOpen=!1;this._domHandler._RemovePeer(this)}}HasClientState(f){return this._domHandler.HasClientValueTag(f)}GetClientState(f){f=
this._domHandler.GetClientValueByTag(f);if(!f)return 0;f=f.GetIndex();if(0===this._clientStateUpdates.length)return 0;const h=this._clientStateUpdates[this._clientStateUpdates.length-1].data;return 0>f||f>=h.length?0:h[f]}GetInterpClientState(f){f=f.GetIndex();if(!this._nextUpdate&&!this._priorUpdate)return 0;if(this._nextUpdate&&!this._priorUpdate){var h=this._nextUpdate.data;return 0>f||f>=h.length?0:h[f]}var b=this._domHandler.GetSimulationTime();let c,g;if(!this._nextUpdate&&this._priorUpdate){if(this._priorUpdate2){var v=
this._priorUpdate2.timestamp;h=this._priorUpdate2.data[f];c=this._priorUpdate.timestamp;g=this._priorUpdate.data[f];b>this._priorUpdate.timestamp+250&&(b=this._priorUpdate.timestamp+250);v=E(v,c,b);return q.InterpNetValue(this._domHandler.GetClientValues()[f].GetInterp(),h,g,v,!0)}h=this._priorUpdate.data;return 0>f||f>=h.length?0:h[f]}v=this._priorUpdate.timestamp;h=this._priorUpdate.data[f];c=this._nextUpdate.timestamp;g=this._nextUpdate.data[f];v=E(v,c,b);return q.InterpNetValue(this._domHandler.GetClientValues()[f].GetInterp(),
h,g,v,!1)}}self.C3Peer=z}"use strict";
{const p=self.C3NetValue,q=self.C3Peer,n=window.RTCPeerConnection||window.webkitRTCPeerConnection||window.mozRTCPeerConnection||window.msRTCPeerConnection,u=window.RTCSessionDescription||window.webkitRTCSessionDescription||window.mozRTCSessionDescription||window.msRTCSessionDescription,w=window.RTCIceCandidate||window.webkitRTCIceCandidate||window.mozRTCIceCandidate||window.msRTCIceCandidate,E=window.RTCDataChannel||window.webkitRTCDataChannel||window.mozRTCDataChannel||window.msRTCDataChannel,z=
[{urls:"stun:stun.l.google.com:19302"}];let f=!1;const h=[];self.RuntimeInterface.AddDOMHandlerClass(class extends self.DOMHandler{constructor(b){super(b,"multiplayer");this._iceServers=[];this._sigWs=null;this._isSignallingLoggedIn=this._isSignallingConnected=!1;this._sigservInfo={protocolrev:0,version:0,name:"",operator:"",motd:""};this._room=this._gameInstance=this._game=this._myAlias=this._myId="";this._allPeers=[];this._peersById=new Map;this._nextPeerNid=0;this._usedPeerNids=new Set;this._hostPeer=
this._selfPeer=null;this._clientDelay=80;this._peerUpdateRateSec=this._hostUpdateRateSec=30;this._lastUpdateTime=0;this._stats={lastSecondTime:0,outboundPerSec:0,outboundCount:0,outboundBandwidthPerSec:0,outboundBandwidthCount:0,inboundPerSec:0,inboundCount:0,inboundBandwidthPerSec:0,inboundBandwidthCount:0};this._dataBuffer=new ArrayBuffer(262144);this._dataView=new DataView(this._dataBuffer);this._allRegisteredObjects=[];this._nextObjectNid=1;this._registeredObjectsByNid=new Map;this._registeredObjectsByRoId=
new Map;this._simPacketLoss=this._simPdv=this._simLatency=0;this._lastTimeDiffs=[];this._hostTimeDiff=this._targetHostTimeDiff=0;this._simDelay=this._targetSimDelay=this._clientDelay;this._allClientValues=[];this._clientValuesByTag=new Map;this._receivedClientValues=!1;this._MergeICEServerList(z);setInterval(()=>this._DoPings(),2E3);window.addEventListener("unload",()=>this.RemoveAllPeers("quit"));this.AddRuntimeMessageHandler("get-supported",()=>this._OnGetSupported());this.AddRuntimeMessageHandler("add-ice-servers",
c=>this._MergeICEServerList(c.list));this.AddRuntimeMessageHandler("simulate-latency",c=>this.SetLatencySimulation(c.latency,c.pdv,c.loss));this.AddRuntimeMessageHandler("set-bandwidth-profile",c=>this.SetBandwidthSettings(c.updateRate,c.delay));this.AddRuntimeMessageHandler("tick",c=>this.Tick(c));this.AddRuntimeMessageHandler("alert",c=>this.Alert(c));this.AddRuntimeMessageHandler("signalling-connect",c=>this.SignallingConnect(c.url));this.AddRuntimeMessageHandler("signalling-disconnect",()=>this.SignallingDisconnect());
this.AddRuntimeMessageHandler("signalling-login",c=>this.SignallingLogin(c.alias));this.AddRuntimeMessageHandler("signalling-join-room",c=>this.SignallingJoinGameRoom(c.game,c.instance,c.room,c.maxClients));this.AddRuntimeMessageHandler("signalling-auto-join-room",c=>this.SignallingAutoJoinGameRoom(c.game,c.instance,c.room,c.maxClients,c.lock));this.AddRuntimeMessageHandler("signalling-leave-room",()=>this.SignallingLeaveRoom());this.AddRuntimeMessageHandler("signalling-list-game-instances",c=>this.SignallingRequestGameInstanceList(c.game));
this.AddRuntimeMessageHandler("signalling-list-rooms",c=>this.SignallingRequestRoomList(c.game,c.instance,c.which));this.AddRuntimeMessageHandler("disconnect-room",()=>this.DisconnectRoom(!0));this.AddRuntimeMessageHandler("peer-send-message",c=>this.OnPeerSendMessage(c));this.AddRuntimeMessageHandler("host-broadcast",c=>this.OnHostBroadcast(c));this.AddRuntimeMessageHandler("kick-peer",c=>this.OnKickPeer(c));this.AddRuntimeMessageHandler("sync-object",c=>this.OnSyncObject(c));this.AddRuntimeMessageHandler("sync-inst-var",
c=>this.OnSyncInstVar(c));this.AddRuntimeMessageHandler("associate-object",c=>this.OnAssociateObject(c));this.AddRuntimeMessageHandler("remove-object-id",c=>this.RemoveObjectId(c.uid));this.AddRuntimeMessageHandler("remove-net-insts",c=>this.OnRemoveNetInsts(c));this.AddRuntimeMessageHandler("remove-object-nid",c=>this.OnRemoveObjectNid(c));this.AddRuntimeMessageHandler("set-client-state",c=>this.SetClientState(c.tag,c.value));this.AddRuntimeMessageHandler("add-client-input-value",c=>this.AddClientInputValue(c.tag,
c.precision,c.interp))}_GetErrorMessage(b){return b?"string"===typeof b?b:"string"===typeof b.message?b.message:"string"===typeof b.details?b.details:"string"===typeof b.data?b.data:"string"===typeof b.type?b.type:"unknown error":"unknown error"}IsConnected(){return this._isSignallingConnected}IsLoggedIn(){return this.IsConnected()&&this._isSignallingLoggedIn}IsInRoom(){return this.IsLoggedIn()&&this._room}IsHost(){return this.IsInRoom()&&this._selfPeer&&this._hostPeer===this._selfPeer}GetMyId(){return this.IsLoggedIn()?
this._myId:""}GetMyAlias(){return this.IsLoggedIn()?this._myAlias:""}GetCurrentGame(){return this.IsLoggedIn()?this._game:""}GetCurrentGameInstance(){return this.IsLoggedIn()?this._gameInstance:""}GetCurrentRoom(){return this.IsInRoom()?this._room:""}GetHostId(){return this._hostPeer?this._hostPeer.GetId():""}GetHostAlias(){return this._hostPeer?this._hostPeer.GetAlias():""}GetHostPeer(){return this._hostPeer}GetSelfPeer(){return this._selfPeer}SetLatencySimulation(b,c,g){this._simLatency=Math.max(b,
0);this._simPdv=Math.max(c,0);this._simPacketLoss=Math.max(g,0)}GetSimulatedPacketLoss(){return this._simPacketLoss}GetSimulatedLatency(){return this._simLatency}GetSimulatedPdv(){return this._simPdv}_OnGetSupported(){return{isSupported:!(!n||!E)}}SignallingConnect(b){if(!this._sigWs&&!this._isSignallingConnected){try{this._sigWs=new WebSocket(b,"c2multiplayer")}catch(c){this._sigWs=null;this._OnSignallingError(c);return}this._sigWs.onopen=()=>{-1===this._sigWs.protocol.indexOf("c2multiplayer")?(this._OnSignallingError("server does not support 'c2multiplayer' protocol"),
this._sigWs.close(1002,"'c2multiplayer' protocol required"),this._sigWs=null,this._isSignallingConnected=!1):this._isSignallingConnected=!0};this._sigWs.onclose=c=>{this._OnSignallingClose();this._isSignallingLoggedIn=this._isSignallingConnected=!1;this._sigWs=null};this._sigWs.onerror=c=>{console.error("Signalling server error: ",c);this._OnSignallingError(c)};this._sigWs.onmessage=c=>{this._OnSignallingMessage(c)}}}SignallingDisconnect(){this._sigWs&&this._isSignallingConnected&&(this._sigWs.close(),
this._sigWs=null,this._isSignallingConnected=!1)}_OnSignallingMessage(b){let c;try{c=JSON.parse(b.data)}catch(g){this._OnSignallingError(g);return}switch(c.message){case "welcome":this._OnSignallingReceiveWelcome(c);break;case "login-ok":this._OnSignallingReceiveLoginOK(c);break;case "join-ok":this._OnSignallingReceiveJoinOK(c);break;case "leave-ok":this._OnSignallingReceiveLeaveOK(c);break;case "kicked":this._OnSignallingReceiveKicked(c);break;case "peer-joined":this._OnSignallingReceivePeerJoined(c);
break;case "peer-quit":this._OnSignallingReceivePeerQuit(c);break;case "icecandidate":this._OnSignallingReceiveIceCandidate(c);break;case "offer":this._OnSignallingReceiveOffer(c);break;case "answer":this._OnSignallingReceiveAnswer(c);break;case "instance-list":this._OnSignallingReceiveInstanceList(c);break;case "room-list":this._OnSignallingReceiveRoomList(c);break;case "error":this._OnSignallingError(c.details);break;default:this._OnSignallingError("received unknown signalling message")}}HasICEServerUrl(b){for(const c of this._iceServers)if(c.urls===
b.urls)return!0;return!1}_MergeICEServerList(b){if(b)for(let c of b)"string"===typeof c&&(c={urls:c}),this.HasICEServerUrl(c)||(c.hasOwnProperty("url")||(c.url=c.urls),this._iceServers.push(c))}GetICEServerList(){return this._iceServers}_OnSignallingError(b){this.PostToRuntime("signalling-error",{message:this._GetErrorMessage(b)})}_OnSignallingClose(){this.PostToRuntime("signalling-close")}_OnSignallingReceiveWelcome(b){if(1>b.protocolrev||1<b.protocolrev)this._OnSignallingError("signalling server protocol revision not supported"),
this.SignallingDisconnect();else{this._myId=b.clientid;var c=this._sigservInfo;c.protocolrev=b.protocolrev;c.version=b.version;c.name=b.name;c.operator=b.operator;c.motd=b.motd;this._MergeICEServerList(b.ice_servers);this.PostToRuntime("signalling-welcome",{myid:this._myId,sigservinfo:{protocolrev:c.protocolrev,version:c.version,name:c.name,operator:c.operator,motd:c.motd}})}}_OnSignallingReceiveLoginOK(b){this._myAlias=b.alias;this._isSignallingLoggedIn=!0;this.PostToRuntime("signalling-login-ok",
{myalias:this._myAlias})}GetNextObjectNid(){return this._nextObjectNid++}AllocatePeerNid(){if(this.IsHost()){do this._nextPeerNid++,65535<this._nextPeerNid&&(this._nextPeerNid=0);while(this._usedPeerNids.has(this._nextPeerNid));var b=this._nextPeerNid;this._usedPeerNids.add(b);return b}}FreePeerNid(b){this.IsHost()&&this._usedPeerNids.delete(b)}_OnSignallingReceiveJoinOK(b){this.RemoveAllPeers("disconnect");this._game=b.game;this._gameInstance=b.instance;this._room=b.room;this._selfPeer=new q(this,
this._myId,this._myAlias);b.host?(this._hostPeer=this._selfPeer,this._nextPeerNid=0,this._usedPeerNids.clear(),this._hostPeer._SetNid(this.AllocatePeerNid())):(this._hostTimeDiff=this._targetHostTimeDiff=this._lastTimeDiffs.length=0,this._clientDelay=80,this._peerUpdateRateSec=this._hostUpdateRateSec=30,this._simDelay=this._targetSimDelay=this._clientDelay,this._hostPeer=new q(this,b.hostid,b.hostalias),this._hostPeer.Connect());this.PostToRuntime("signalling-join-ok",{isHost:!!b.host,hostId:this._hostPeer.GetId(),
hostAlias:this._hostPeer.GetAlias(),game:this._game,gameInstance:this._gameInstance,room:this._room})}_OnSignallingReceiveLeaveOK(b){this._room="";this.PostToRuntime("signalling-leave-ok")}_OnSignallingReceiveKicked(b){this.DisconnectRoom();this._room="";this.PostToRuntime("signalling-kicked")}_OnSignallingReceivePeerJoined(b){if(this._isSignallingLoggedIn&&this._room&&this.IsHost()){var c=this._peersById.get(b.peerid);c&&c.Remove("rejoin");(new q(this,b.peerid,b.peeralias)).Connect()}}_OnSignallingReceivePeerQuit(b){if(this._isSignallingLoggedIn&&
this._room&&this.IsHost()){var c=this._peersById.get(b.id);c&&c.Remove(b.reason)}}_OnSignallingReceiveIceCandidate(b){if(this._isSignallingLoggedIn&&this._room){var c=this._peersById.get(b.from);c&&c._AddICECandidate(new w(b.icecandidate))}}_OnSignallingReceiveOffer(b){if(this._isSignallingLoggedIn&&this._room&&!this.IsHost()&&this._selfPeer&&this._hostPeer&&this._hostPeer.HasPeerConnection()&&b.from===this._hostPeer.GetId()){var c=this._hostPeer.GetPeerConnection();c.setRemoteDescription(new u(b.offer)).then(()=>
{c.createAnswer().then(g=>{c.setLocalDescription(g);this.SignallingSend({message:"answer",toclientid:this._hostPeer.GetId(),answer:g})}).catch(g=>{console.error("Peer error creating answer: ",g);this._OnPeerError(this._selfPeer,"could not create answer to host offer")})}).catch(g=>{console.error("Peer error setting remote description: ",g);this._OnPeerError(this._selfPeer,"could not set remote description")})}}_OnSignallingReceiveAnswer(b){if(this._isSignallingLoggedIn&&this._room&&this.IsHost()){var c=
this._peersById.get(b.from);c&&c.GetPeerConnection().setRemoteDescription(new u(b.answer)).catch(g=>{console.error("Host error setting remote description: ",g)})}}_OnSignallingReceiveInstanceList(b){this.PostToRuntime("signalling-instance-list",{list:b.list})}_OnSignallingReceiveRoomList(b){this.PostToRuntime("signalling-room-list",{list:b.list})}SignallingSend(b){this._sigWs&&this._isSignallingConnected&&this._sigWs.send(JSON.stringify(b))}SignallingLogin(b){this._isSignallingLoggedIn||this.SignallingSend({message:"login",
protocolrev:1,alias:b})}SignallingJoinGameRoom(b,c,g,v){this._isSignallingLoggedIn&&!this._room&&this.SignallingSend({message:"join",game:b,instance:c,room:g,max_clients:v})}SignallingAutoJoinGameRoom(b,c,g,v,e){this._isSignallingLoggedIn&&!this._room&&this.SignallingSend({message:"auto-join",game:b,instance:c,room:g,max_clients:v,lock_when_full:e})}SignallingLeaveRoom(){this._isSignallingLoggedIn&&this.SignallingSend({message:"leave"})}SignallingConfirmPeer(b){this._isSignallingLoggedIn&&this.IsHost()&&
this.SignallingSend({message:"confirm-peer",id:b})}SignallingRequestGameInstanceList(b){this._sigWs&&this._isSignallingConnected&&this.SignallingSend({message:"list-instances",game:b})}SignallingRequestRoomList(b,c,g){this._sigWs&&this._isSignallingConnected&&this.SignallingSend({message:"list-rooms",game:b,instance:c,which:g})}DisconnectRoom(b){this._hostTimeDiff=this._targetHostTimeDiff=this._lastTimeDiffs.length=0;this.RemoveAllPeers("disconnect");for(const c of this._allRegisteredObjects)c.ClearAllNetInstances();
b&&this.SignallingLeaveRoom()}_AddPeer(b){this._allPeers.push(b);this._peersById.set(b.GetId(),b);this.PostToRuntime("add-peer",{id:b.GetId(),alias:b.GetAlias()})}_RemovePeer(b){this.PostToRuntime("remove-peer",{id:b.GetId()});this.IsHost()&&this.FreePeerNid(b.GetNid());const c=this._allPeers.indexOf(b);-1<c&&this._allPeers.splice(c,1);this._peersById.delete(b.GetId());this._hostPeer===b&&(this._hostPeer=null,this.RemoveAllPeers("host quit"));this._selfPeer===b&&(this._selfPeer=null,this._room="",
this.RemoveAllPeers("disconnect"))}RemoveAllPeers(b){if(!f){for(f=!0;this._allPeers.length;)this._allPeers[0].Remove(b);f=!1}}GetPeerById(b){return this._peersById.get(b)||null}GetAliasFromId(b){return(b=this._peersById.get(b))?b.GetAlias():""}GetPeerByNid(b){for(const c of this._allPeers)if(c.GetNid()===b)return c;return null}OnHostBroadcast(b){const c=b.fromId,g=b.tag,v=b.message;b=b.mode;const e=this.GetPeerById(c);this.HostBroadcast(b,JSON.stringify({c:"m",t:g,f:c,m:v}),e)}HostBroadcast(b,c,g){if(this.IsHost()){var v=
this._allPeers.slice(0);for(const e of v)e&&e!==this._selfPeer&&e!==g&&e.Send(b,c)}}_DoPings(){const b=performance.now();if(this.IsHost()){h.push(...this._allPeers);for(const c of h)c&&c!==this._selfPeer&&c.SendPing(b,!1);h.length=0}else this._hostPeer&&this._hostPeer.SendPing(b,!1)}AddRegisteredObject(b){this._allRegisteredObjects.push(b);this._registeredObjectsByRoId.set(b.GetRoId(),b);this._registeredObjectsByNid.set(b.GetNid(),b)}GetRegisteredObjectsMap(){const b={};for(const [c,g]of this._registeredObjectsByNid.entries())b[g.GetSid()]=
{nid:c,nvs:g.GetNetValuesJson()};return b}MapObjectNids(b){this._registeredObjectsByNid.clear();for(const c of this._allRegisteredObjects)if(b.hasOwnProperty(c.GetSid().toString())){const g=b[c.GetSid().toString()];c._SetNid(g.nid);this._registeredObjectsByNid.set(g.nid,c);c.SetNetValuesFrom(g.nvs)}else console.warn("Could not map object SID '"+c.GetSid()+"' - host did not send NID for it"),c._SetNid(-1)}GetRegisteredObjectByNid(b){return this._registeredObjectsByNid.get(b)||null}Tick(b){if(!this.IsInRoom())return null;
b=b.dt;const c=performance.now();var g=this.IsHost()?this._hostUpdateRateSec:this._peerUpdateRateSec;c-this._lastUpdateTime>=1E3/g-5&&(this.SendUpdate(c),this._lastUpdateTime=c);g=this._stats;1E3<=c-g.lastSecondTime&&(g.outboundPerSec=g.outboundCount,g.outboundBandwidthPerSec=g.outboundBandwidthCount,g.inboundPerSec=g.inboundCount,g.inboundBandwidthPerSec=g.inboundBandwidthCount,g.outboundCount=0,g.outboundBandwidthCount=0,g.inboundCount=0,g.inboundBandwidthCount=0,g.lastSecondTime+=1E3,500<c-g.lastSecondTime&&
(g.lastSecondTime=c),this.PostToRuntime("stats",{stats:{outboundPerSec:g.outboundPerSec,outboundBandwidthPerSec:g.outboundBandwidthPerSec,inboundPerSec:g.inboundPerSec,inboundBandwidthPerSec:g.inboundBandwidthPerSec}}));this.IsHost()||(this._hostTimeDiff<this._targetHostTimeDiff?(this._hostTimeDiff+=10*b,this._hostTimeDiff>this._targetHostTimeDiff&&(this._hostTimeDiff=this._targetHostTimeDiff)):this._hostTimeDiff>this._targetHostTimeDiff&&(this._hostTimeDiff-=10*b,this._hostTimeDiff<this._targetHostTimeDiff&&
(this._hostTimeDiff=this._targetHostTimeDiff)),this._simDelay<this._targetSimDelay?(this._simDelay+=30*b,this._simDelay>this._targetSimDelay&&(this._simDelay=this._targetSimDelay)):this._simDelay>this._targetSimDelay&&(this._simDelay-=30*b,this._simDelay<this._targetSimDelay&&(this._simDelay=this._targetSimDelay)));b=this.GetSimulationTime();for(const v of this._allPeers)v.Tick(b);for(const v of this._allRegisteredObjects)v.Tick();return{simulationTime:this.GetSimulationTime(),hostInputArrivalTime:this.GetHostInputArrivalTime(),
clientDelay:this._clientDelay,peerData:this._GetPeerRuntimeData(),roData:this._GetRegisteredObjectRuntimeData(),isReadyForInput:this.IsReadyForInput()}}_GetPeerRuntimeData(){const b={};for(const c of this._allPeers){const g={};for(const v of this._allClientValues)g[v.GetTag()]=c.GetInterpClientState(v);b[c.GetId()]={nid:c.GetNid(),latency:c.GetLatency(),pdv:c.GetPdv(),clientState:g}}return b}_GetRegisteredObjectRuntimeData(){const b={};for(const c of this._allRegisteredObjects)b[c.GetRoId()]=c.GetRuntimeData();
return b}async SendUpdate(b){this.IsHost()?(await this._SendHostUpdate(b),this._SendHostEvents(b)):await this._SendClientUpdate(b)}async _OnBeforeClientUpdate(){const b=await this.PostToRuntimeAsync("before-client-update");for(const c of b.clientStateUpdates)this.SetClientState(c.tag,c.value)}async _SendClientUpdate(b){this.IsReadyForInput()&&await this._OnBeforeClientUpdate();if(this._selfPeer&&this._receivedClientValues){var c=this._dataView,g=0,v=this._allClientValues,e=this._selfPeer.GetLocalClientState(),
k=b-this._selfPeer.GetLastStateChange(),r=b-this._selfPeer.GetLastStateTransmit();if(100>k||(1E3>k?95<=r:495<=r)){c.setUint32(g,1664249200);g+=4;c.setFloat64(g,b+this._hostTimeDiff);g+=8;c.setUint8(g,0);g+=1;c.setUint8(g,v.length);g+=1;for(let x=0,y=v.length;x<y;++x)k=v[x],r=0,x<e.length&&(r=k.Clamp(e[x])),g=k.Write(c,g,r);this._selfPeer._SetLastStateTransmit(b);this._hostPeer.Send("u",new Uint8Array(this._dataBuffer.slice(0,g)))}}}async _SendHostUpdate(b){const c=this._dataView;let g=0,v=0;const e=
await this.PostToRuntimeAsync("get-object-info",{ros:this._allRegisteredObjects.map(k=>k.GetRuntimeInfoRequest())});for(const k of this._allRegisteredObjects){const r=k.GetRoId();e.hasOwnProperty(r)&&(k.UpdateData(e[r],b),0<k.GetNumberToTransmit()&&v++)}if(0!==v){c.setUint32(g,1664249200);g+=4;c.setUint32(g,0);g+=4;c.setFloat64(g,b);g+=8;c.setUint16(g,v);g+=2;for(const k of this._allRegisteredObjects)0<k.GetNumberToTransmit()&&(g=k.WriteData(c,g,b));this.HostBroadcast("u",new Uint8Array(this._dataBuffer.slice(0,
g)),null)}}_SendHostEvents(b){const c=this._dataView;let g=0,v=0;for(const e of this._allRegisteredObjects)e.GetDeadNids().length&&v++;if(0!==v){c.setUint32(g,1664249200);g+=4;c.setUint32(g,1);g+=4;c.setFloat64(g,b);g+=8;c.setUint16(g,v);g+=2;for(const e of this._allRegisteredObjects)if(b=e.GetDeadNids(),b.length){c.setUint16(g,e.GetNid());g+=2;c.setUint16(g,b.length);g+=2;for(const k of b)c.setUint16(g,k),g+=2;b.length=0}this.HostBroadcast("r",new Uint8Array(this._dataBuffer.slice(0,g)),null)}}AddHostTime(b,
c,g,v){if(!this.IsHost()){this._targetSimDelay=v+this._clientDelay;b=b+g-c;0===this._lastTimeDiffs.length&&(this._hostTimeDiff=b,this._simDelay=this._targetSimDelay);this._lastTimeDiffs.push(b);30<this._lastTimeDiffs.length&&this._lastTimeDiffs.shift();h.push(...this._lastTimeDiffs);h.sort((e,k)=>e-k);b=0;c=h.length;4<=h.length&&6>=h.length?(++b,--c):6<h.length&&19>=h.length?(b+=2,c-=2):19<h.length&&(b+=5,c-=5);g=0;for(v=b;v<c;++v)g+=h[v];this._targetHostTimeDiff=g/(c-b);h.length=0}}GetSimulationTime(){return this.IsHost()?
performance.now()-this._clientDelay:performance.now()+this._hostTimeDiff-this._simDelay}GetHostTime(){return this.IsHost()?performance.now():performance.now()+this._hostTimeDiff}GetHostInputArrivalTime(){return this.IsHost()?performance.now():performance.now()+this._hostTimeDiff+this._simDelay}SetClientState(b,c){if(!this.IsHost()&&this._selfPeer&&this._receivedClientValues&&(b=this._clientValuesByTag.get(b))){b=b.GetIndex();var g=this._selfPeer.GetLocalClientState();g.length<b+1&&(g.length=b+1);
g[b]!==c&&(g[b]=c,this._selfPeer._SetLastStateChange(performance.now()))}}AddClientInputValue(b,c,g){c=new p(this._allClientValues.length,g,c,b,null);this._clientValuesByTag.set(b,c);this._allClientValues.push(c)}GetClientValues(){return this._allClientValues}GetClientValuesJson(){const b=[];for(const c of this._allClientValues)b.push({tag:c.GetTag(),precision:c.GetPrecision(),interp:c.GetInterp()});return b}MapClientValues(b){this._clientValuesByTag.clear();this._allClientValues.length=0;for(let g=
0,v=b.length;g<v;++g){var c=b[g];c=new p(g,c.interp,c.precision,c.tag,null);this._clientValuesByTag.set(c.GetTag(),c);this._allClientValues.push(c)}this._receivedClientValues=!0}RemoveObjectId(b){for(const c of this._allRegisteredObjects)c.RemoveObjectId(b)}peers(){return this._allPeers}GetPeerCount(){return this.IsInRoom()?this._allPeers.length:0}GetPeerAt(b){b=Math.floor(b);return!this.IsInRoom()||0>b||b>=this._allPeers.length?null:this._allPeers[b]}IsReadyForInput(){return this.IsInRoom()?this.IsHost()?
!0:0!==this._targetHostTimeDiff:!1}SetBandwidthSettings(b,c){this.IsInRoom()||(this._peerUpdateRateSec=this._hostUpdateRateSec=b,this._clientDelay=c)}_OnPeerOpen(b){this.PostToRuntime("peer-open",{id:b.GetId(),alias:b.GetAlias()})}OnPeerSendMessage(b){const c=b.tag,g=b.message,v=b.mode;(b=this.GetPeerById(b.id))&&b.Send(v,JSON.stringify({c:"m",t:c,m:g}))}_OnPeerClose(b,c){this.PostToRuntime("peer-close",{id:b.GetId(),alias:b.GetAlias(),reason:c||"unknown"})}_OnPeerError(b,c){console.error(`[Multiplayer] Peer '${b.GetAlias()}' (${b.GetId()}) error: `,
c)}_OnPeerMessage(b,c){b=c.f||b.GetId();this.PostToRuntime("peer-message",{tag:c.t,fromId:b,fromAlias:this.GetAliasFromId(b),content:c.m})}_OnInstanceDestroyed(b,c,g){this.PostToRuntime("instance-destroyed",{roId:b.GetRoId(),nid:c,timestamp:g})}OnKickPeer(b){if(this.IsHost()){var c=b.reason;(b=this.GetPeerById(b.id))&&b.Remove(c,!0)}}StatIncOutboundCount(){this._stats.outboundCount++}StatAddOutboundBandwidthCount(b){this._stats.outboundBandwidthCount+=b}StatIncInboundCount(){this._stats.inboundCount++}StatAddInboundBandwidthCount(b){this._stats.inboundBandwidthCount+=
b}SetClientDelay(b){this._clientDelay=b}GetClientDelay(){return this._clientDelay}SetPeerUpdateRateSec(b){this._peerUpdateRateSec=b}GetPeerUpdateRateSec(){return this._peerUpdateRateSec}OnSyncObject(b){const c=b.data,g=b.precision,v=b.bandwidth;for(const e of b.objectClasses)b=new self.C3RegisteredObject(this,e.roId,e.sid,v),1===c?(b.AddValue(1,g,"x"),b.AddValue(1,g,"y")):2===c?b.AddValue(2,g,"a"):3===c&&(b.AddValue(1,g,"x"),b.AddValue(1,g,"y"),b.AddValue(2,g,"a"))}Alert(b){alert(b.message)}OnSyncInstVar(b){const c=
b.precision,g=b.interp,v=b.cvt;for(const e of b.syncData)this._registeredObjectsByRoId.get(e.roId).AddValue(g,c,"iv",e.varIndex,v)}OnAssociateObject(b){var c=b.peerId;const g=b.instUid;b=this._registeredObjectsByRoId.get(b.roId);c=this._peersById.get(c);b&&c&&this.IsHost()&&b.OverrideNid(g,c.GetNid())}OnRemoveNetInsts(b){for(const [c,g]of Object.entries(b))if(b=this._registeredObjectsByRoId.get(parseInt(c,10)))for(const v of g)b.RemoveObjectNid(v)}OnRemoveObjectNid(b){const c=b.nid;(b=this._registeredObjectsByRoId.get(b.roId))&&
b.RemoveObjectNid(c)}})};
